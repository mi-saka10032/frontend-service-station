<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.53" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="http://localhost:8080/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html"><meta property="og:site_name" content="前端加油站"><meta property="og:title" content="Webpack原理"><meta property="og:description" content="主要围绕 Webpack 从初始化 -> 编译 -> 输出到结束的整个生命周期阶段简单分析，其中再着重分析一下内存打包、HMR、Tree-shaking 参考链接 1：https://juejin.cn/post/6844903614469636103 参考链接 2：https://blog.csdn.net/major_zhang/article/d..."><meta property="og:type" content="article"><meta property="og:updated_time" content="2023-03-16T14:33:26.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:tag" content="Webpack"><meta property="article:tag" content="运行流程"><meta property="article:tag" content="编译阶段"><meta property="article:tag" content="输出阶段"><meta property="article:tag" content="内存贮存"><meta property="article:tag" content="双工通信"><meta property="article:modified_time" content="2023-03-16T14:33:26.000Z"><link rel="icon" href="/frontend-service-station/favicon.ico"><link rel="icon" href="/frontend-service-station/misaka10032.png" type="image/png" sizes="512x512"><link rel="manifest" href="/frontend-service-station/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/frontend-service-station/misaka10032.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/frontend-service-station/misaka10032.png"><meta name="msapplication-TileColor" content="#46bd87"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>Webpack原理 | 前端加油站</title><meta name="description" content="主要围绕 Webpack 从初始化 -> 编译 -> 输出到结束的整个生命周期阶段简单分析，其中再着重分析一下内存打包、HMR、Tree-shaking 参考链接 1：https://juejin.cn/post/6844903614469636103 参考链接 2：https://blog.csdn.net/major_zhang/article/d...">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/frontend-service-station/assets/style.ac40b8f0.css" as="style" /><link rel="stylesheet" href="/frontend-service-station/assets/style.ac40b8f0.css" />
    <link rel="modulepreload" href="/frontend-service-station/assets/app.b7c991a3.js"><link rel="modulepreload" href="/frontend-service-station/assets/4-webpack原理.html.df0f25ff.js"><link rel="modulepreload" href="/frontend-service-station/assets/_plugin-vue_export-helper.cdc0426e.js"><link rel="modulepreload" href="/frontend-service-station/assets/4-webpack原理.html.5a50d1ec.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/frontend-service-station/" class="brand"><img class="logo" src="/frontend-service-station/misaka10032.png" alt="前端加油站"><!----><span class="site-name hide-in-pad">前端加油站</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/frontend-service-station/" class="nav-link" aria-label="首页"><span class="icon iconfont icon-home"></span>首页<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="基础"><span class="title"><span class="icon iconfont icon-enum"></span>基础</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/frontend-service-station/base/html/HTML%E5%9F%BA%E7%A1%80.html" class="nav-link" aria-label="HTML"><span class="icon iconfont icon-html"></span>HTML<!----></a></li><li class="dropdown-item"><a href="/frontend-service-station/base/css/CSS%E5%9F%BA%E7%A1%80.html" class="nav-link" aria-label="CSS"><span class="icon iconfont icon-css"></span>CSS<!----></a></li><li class="dropdown-item"><a href="/frontend-service-station/base/javascript" class="nav-link" aria-label="Javascript"><span class="icon iconfont icon-javascript"></span>Javascript<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="框架"><span class="title"><span class="icon iconfont icon-frame"></span>框架</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/frontend-service-station/vue2/1-%E7%AE%80%E4%BB%8B.html" class="nav-link" aria-label="Vue2"><span class="icon iconfont icon-vue"></span>Vue2<!----></a></li><li class="dropdown-item"><a href="/frontend-service-station/vue3/1-%E7%AE%80%E4%BB%8B.html" class="nav-link" aria-label="Vue3"><span class="icon iconfont icon-vue"></span>Vue3<!----></a></li><li class="dropdown-item"><a href="/frontend-service-station/react/1-%E7%AE%80%E4%BB%8B.html" class="nav-link" aria-label="React"><span class="icon iconfont icon-react"></span>React<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="构建工具"><span class="title"><span class="icon iconfont icon-build"></span>构建工具</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/frontend-service-station/webpack/2-primary.html" class="nav-link" aria-label="Webpack"><span class="icon iconfont icon-view"></span>Webpack<!----></a></li><li class="dropdown-item"><a href="/frontend-service-station/webpack/5-vuecli.html" class="nav-link" aria-label="VueCli"><span class="icon iconfont icon-vue"></span>VueCli<!----></a></li><li class="dropdown-item"><a href="/frontend-service-station/webpack/6-vite.html" class="nav-link" aria-label="Vite"><span class="icon iconfont icon-valine"></span>Vite<!----></a></li><li class="dropdown-item"><a href="/frontend-service-station/webpack/8-umi.html" class="nav-link" aria-label="Umi"><span class="icon iconfont icon-react"></span>Umi<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="性能优化"><span class="title"><span class="icon iconfont icon-launch"></span>性能优化</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/frontend-service-station/performance/2-interactive.html" class="nav-link" aria-label="界面交互"><span class="icon iconfont icon-chrome"></span>界面交互<!----></a></li><li class="dropdown-item"><a href="/frontend-service-station/performance/3-target.html" class="nav-link" aria-label="性能指标"><span class="icon iconfont icon-ability"></span>性能指标<!----></a></li><li class="dropdown-item"><a href="/frontend-service-station/performance/5-cache.html" class="nav-link" aria-label="缓存技术"><span class="icon iconfont icon-cache"></span>缓存技术<!----></a></li><li class="dropdown-item"><a href="/frontend-service-station/performance/6-nginx.html" class="nav-link" aria-label="Nginx"><span class="icon iconfont icon-nginx"></span>Nginx<!----></a></li></ul></button></div></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/mi-saka10032/frontend-service-station" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg></button><!--]--><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/frontend-service-station/" class="nav-link sidebar-link sidebar-page" aria-label="首页"><span class="icon iconfont icon-home"></span>首页<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-ajax"></span><span class="title">AJAX</span><span class="arrow right"></span></button><!----></section></li><li><!--[--><a href="/frontend-service-station/git.html" class="nav-link sidebar-link sidebar-page" aria-label="Git"><span class="icon iconfont icon-git"></span>Git<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-nodeJS"></span><span class="title">Node</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-react"></span><span class="title">React</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-preview"></span><span class="title">React源码分析</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-snow"></span><span class="title">THREE基础</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-typescript"></span><span class="title">TypeScript</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-vue"></span><span class="title">Vue2</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-vue"></span><span class="title">Vue3</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-preview"></span><span class="title">Vue源码分析</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-enum"></span><span class="title">前端三剑客</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-page"></span><span class="title">前端渲染模式</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-process"></span><span class="title">前端设计模式</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-customize"></span><span class="title">微前端</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-launch"></span><span class="title">性能优化</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="icon iconfont icon-build"></span><span class="title">构建工具</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/frontend-service-station/webpack/1-preface.html" class="nav-link sidebar-link sidebar-page" aria-label="前言"><!---->前言<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/frontend-service-station/webpack/2-primary.html" class="nav-link sidebar-link sidebar-page" aria-label="webpack基础配置"><!---->webpack基础配置<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/frontend-service-station/webpack/3-senior.html" class="nav-link sidebar-link sidebar-page" aria-label="webpack进阶配置"><!---->webpack进阶配置<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="Webpack原理"><!---->Webpack原理<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#基本概念" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="基本概念"><!---->基本概念<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#流程概括" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="流程概括"><!---->流程概括<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#流程细节" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="流程细节"><!---->流程细节<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#初始化阶段" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="初始化阶段"><!---->初始化阶段<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#编译阶段" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="编译阶段"><!---->编译阶段<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#输出阶段" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="输出阶段"><!---->输出阶段<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#输出文件分析" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="输出文件分析"><!---->输出文件分析<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#分割代码时的输出" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="分割代码时的输出"><!---->分割代码时的输出<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#简析-loader" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="简析 Loader"><!---->简析 Loader<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#plugin" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Plugin"><!---->Plugin<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#complier-和-compilation" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Complier 和 Compilation"><!---->Complier 和 Compilation<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#事件流" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="事件流"><!---->事件流<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#修改输出资源" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="修改输出资源"><!---->修改输出资源<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#内存系统打包" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="内存系统打包"><!---->内存系统打包<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#memory-fs" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="memory-fs"><!---->memory-fs<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#简单实现" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="简单实现"><!---->简单实现<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#hmr" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="HMR"><!---->HMR<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#hmr-配置" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="HMR 配置"><!---->HMR 配置<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#工作原理图解" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="工作原理图解"><!---->工作原理图解<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#第一步-文件系统监听并打包" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="第一步：文件系统监听并打包"><!---->第一步：文件系统监听并打包<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#第二步-文件内容改变" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="第二步：文件内容改变"><!---->第二步：文件内容改变<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#第三步-客户端接收并响应" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="第三步：客户端接收并响应"><!---->第三步：客户端接收并响应<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#第四步-hash-验证及请求代码" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="第四步：hash 验证及请求代码"><!---->第四步：hash 验证及请求代码<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#第五步-模块热更新" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="第五步：模块热更新"><!---->第五步：模块热更新<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#第六步-业务代码执行" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="第六步：业务代码执行"><!---->第六步：业务代码执行<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#总结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="总结"><!---->总结<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#tree-shaking" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Tree Shaking"><!---->Tree Shaking<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#dead-code" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Dead Code"><!---->Dead Code<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#实现前提" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="实现前提"><!---->实现前提<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#实现原理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="实现原理"><!---->实现原理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#标记效果" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="标记效果"><!---->标记效果<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#副作用" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="副作用"><!---->副作用<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#副作用规避" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="副作用规避"><!---->副作用规避<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/frontend-service-station/webpack/5-vuecli.html" class="nav-link sidebar-link sidebar-page" aria-label="VueCli"><!---->VueCli<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/frontend-service-station/webpack/6-vite.html" class="nav-link sidebar-link sidebar-page" aria-label="Vite"><!---->Vite<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/frontend-service-station/webpack/7-vite%E5%8E%9F%E7%90%86.html" class="nav-link sidebar-link sidebar-page" aria-label="Vite原理"><!---->Vite原理<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/frontend-service-station/webpack/8-umi.html" class="nav-link sidebar-link sidebar-page" aria-label="Umi"><!---->Umi<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Webpack原理</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://github.com/mi-saka10032?tab=repositories" target="_blank" rel="noopener noreferrer">Misaka10032</a></span><span property="author" content="Misaka10032"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-02-14T01:17:20.000Z"></span><!----><span aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><ul class="tags-wrapper"><li><span class="tag tag0" role>Webpack</span></li><li><span class="tag tag6" role>运行流程</span></li><li><span class="tag tag4" role>编译阶段</span></li><li><span class="tag tag3" role>输出阶段</span></li><li><span class="tag tag3" role>内存贮存</span></li><li><span class="tag tag4" role>双工通信</span></li></ul><meta property="keywords" content="Webpack,运行流程,编译阶段,输出阶段,内存贮存,双工通信"></span><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 34 分钟</span><meta property="timeRequired" content="PT34M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#基本概念" class="router-link-active router-link-exact-active toc-link level2">基本概念</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#流程概括" class="router-link-active router-link-exact-active toc-link level2">流程概括</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#流程细节" class="router-link-active router-link-exact-active toc-link level2">流程细节</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#初始化阶段" class="router-link-active router-link-exact-active toc-link level2">初始化阶段</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#编译阶段" class="router-link-active router-link-exact-active toc-link level2">编译阶段</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#输出阶段" class="router-link-active router-link-exact-active toc-link level2">输出阶段</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#输出文件分析" class="router-link-active router-link-exact-active toc-link level2">输出文件分析</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#分割代码时的输出" class="router-link-active router-link-exact-active toc-link level2">分割代码时的输出</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#简析-loader" class="router-link-active router-link-exact-active toc-link level2">简析 Loader</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#plugin" class="router-link-active router-link-exact-active toc-link level2">Plugin</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#complier-和-compilation" class="router-link-active router-link-exact-active toc-link level2">Complier 和 Compilation</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#事件流" class="router-link-active router-link-exact-active toc-link level2">事件流</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#修改输出资源" class="router-link-active router-link-exact-active toc-link level2">修改输出资源</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#内存系统打包" class="router-link-active router-link-exact-active toc-link level2">内存系统打包</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#memory-fs" class="router-link-active router-link-exact-active toc-link level3">memory-fs</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#简单实现" class="router-link-active router-link-exact-active toc-link level3">简单实现</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#hmr" class="router-link-active router-link-exact-active toc-link level2">HMR</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#hmr-配置" class="router-link-active router-link-exact-active toc-link level3">HMR 配置</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#工作原理图解" class="router-link-active router-link-exact-active toc-link level3">工作原理图解</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#第一步-文件系统监听并打包" class="router-link-active router-link-exact-active toc-link level3">第一步：文件系统监听并打包</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#第二步-文件内容改变" class="router-link-active router-link-exact-active toc-link level3">第二步：文件内容改变</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#第三步-客户端接收并响应" class="router-link-active router-link-exact-active toc-link level3">第三步：客户端接收并响应</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#第四步-hash-验证及请求代码" class="router-link-active router-link-exact-active toc-link level3">第四步：hash 验证及请求代码</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#第五步-模块热更新" class="router-link-active router-link-exact-active toc-link level3">第五步：模块热更新</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#第六步-业务代码执行" class="router-link-active router-link-exact-active toc-link level3">第六步：业务代码执行</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#总结" class="router-link-active router-link-exact-active toc-link level3">总结</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#tree-shaking" class="router-link-active router-link-exact-active toc-link level2">Tree Shaking</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#dead-code" class="router-link-active router-link-exact-active toc-link level3">Dead Code</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#实现前提" class="router-link-active router-link-exact-active toc-link level3">实现前提</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#实现原理" class="router-link-active router-link-exact-active toc-link level3">实现原理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#标记效果" class="router-link-active router-link-exact-active toc-link level3">标记效果</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#副作用" class="router-link-active router-link-exact-active toc-link level3">副作用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/frontend-service-station/webpack/4-webpack%E5%8E%9F%E7%90%86.html#副作用规避" class="router-link-active router-link-exact-active toc-link level3">副作用规避</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><p>主要围绕 Webpack 从初始化 -&gt; 编译 -&gt; 输出到结束的整个生命周期阶段简单分析，其中再着重分析一下内存打包、HMR、Tree-shaking</p><p>参考链接 1：<a href="https://juejin.cn/post/6844903614469636103" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6844903614469636103<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>参考链接 2：<a href="https://blog.csdn.net/major_zhang/article/details/84557665" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/major_zhang/article/details/84557665<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>参考链接 3：<a href="https://zhuanlan.zhihu.com/p/30669007" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/30669007<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>参考链接 4：<a href="https://www.51cto.com/article/681949.html" target="_blank" rel="noopener noreferrer">https://www.51cto.com/article/681949.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="基本概念" tabindex="-1"><a class="header-anchor" href="#基本概念" aria-hidden="true">#</a> 基本概念</h2><p>Webpack 五个核心概念：</p><ol><li>Entry：入口。Webpack 执行构建的第一步将从 Entry 开始，可抽象成输入</li><li>Module：模块。在 Webpack 里一切皆模块，一个模块对应着一个文件。Webpack 会从配置的 Entry 开始递归找出所有依赖的模块</li><li>Chunk：代码块。一个 Chunk 由多个模块组合而成，用于代码合并与分割</li><li>Loader：模块转换器。用于把模块原内容按照需求转换成新内容</li><li>Plugin：扩展插件，在 Webpack 构建流程中的特定时机会广播对应的事件，插件可以监听这些事件的发生，在特定时机做对应的事情</li></ol><h2 id="流程概括" tabindex="-1"><a class="header-anchor" href="#流程概括" aria-hidden="true">#</a> 流程概括</h2><p>Webpack 的运行流程是一个串行的过程，从启动到结束会依次执行以下流程</p><ol><li>初始化参数：从配置文件和 Shell 语句中读取与合并参数，得出最终的参数；</li><li>开始编译：用上一步得到的参数初始化 Compiler 对象，加载所有配置的插件，执行对象的 run 方法开始执行编译；</li><li>确定入口：根据配置中的 entry 找出所有的入口文件；</li><li>编译模块：从入口文件出发，调用所有配置的 Loader 对模块进行翻译，再找出该模块依赖的模块，再递归本步骤直到所有入口依赖的文件都经过了本步骤的处理；</li><li>完成模块编译：在经过第 4 步使用 Loader 翻译完所有模块后，得到了每个模块被翻译后的最终内容以及它们之间的依赖关系；</li><li>输出资源：根据入口和模块之间的依赖关系，组装成一个个包含多个模块的 Chunk，再把每个 Chunk 转换成一个单独的文件加入到输出列表，这步是可以修改输出内容的最后机会；</li><li>输出完成：在确定好输出内容后，根据配置确定输出的路径和文件名，把文件内容写入到文件系统。</li></ol><p>在以上过程中，Webpack 会在特定的时间点广播出特定的事件，插件在监听到感兴趣的事件后会执行特定的逻辑，并且插件可以调用 Webpack 提供的 API 改变 Webpack 的运行结果。</p><h2 id="流程细节" tabindex="-1"><a class="header-anchor" href="#流程细节" aria-hidden="true">#</a> 流程细节</h2><p>Webpack 的构建流程可以分为以下三大阶段：</p><ol><li>初始化：启动构建，读取与合并配置参数，加载 Plugin，实例化 Compiler。</li><li>编译：从 Entry 发出，针对每个 Module 串行调用对应的 Loader 去翻译文件内容，再找到该 Module 依赖的 Module，递归地进行编译处理。</li><li>输出：对编译后的 Module 组合成 Chunk，把 Chunk 转换成文件，输出到文件系统。</li></ol><p>如果只执行一次构建，以上阶段将会按照顺序各执行一次。但在开启监听模式下，流程将变为如下：</p><p>在每个大阶段中又会发生很多事件，Webpack 会把这些事件广播出来供给 Plugin 使用，下面来一一介绍。</p><h2 id="初始化阶段" tabindex="-1"><a class="header-anchor" href="#初始化阶段" aria-hidden="true">#</a> 初始化阶段</h2><table><thead><tr><th style="text-align:left;">事件名</th><th style="text-align:left;">注释</th></tr></thead><tbody><tr><td style="text-align:left;">初始化参数</td><td style="text-align:left;">从配置文件和 Shell 语句中读取与合并参数，得出最终的参数。这个过程中还会执行配置文件中的插件实例化语句<code>new Plugin()</code></td></tr><tr><td style="text-align:left;">实例化 Compiler</td><td style="text-align:left;">用上一步得到的参数初始化 Compiler 实例，Compiler 负责文件监听和启动编译。Compiler 实例中包含了完整的 Webpack 配置，全局只有一个 Compiler 实例</td></tr><tr><td style="text-align:left;">加载插件</td><td style="text-align:left;">依次调用插件的 apply 方法，让插件可以监听后续的所有事件节点，同时给插件传入 compiler 实例的引用，以方便插件通过 compiler 调用 Webpack 提供的 API</td></tr><tr><td style="text-align:left;">environment</td><td style="text-align:left;">开始应用 Node.js 风格的文件系统到 compiler 对象，以便后续的文件寻找和读取</td></tr><tr><td style="text-align:left;">entry-option</td><td style="text-align:left;">读取配置的 Entrys，为每个 Entry 实例化一个对应的 EntryPlugin，为后面该 Entry 的递归解析工作做准备</td></tr><tr><td style="text-align:left;">after-plugins</td><td style="text-align:left;">调用完所有内置和配置的插件的 apply 方法</td></tr><tr><td style="text-align:left;">after-resolvers</td><td style="text-align:left;">根据配置初始化完 resolver，resolver 负责在文件系统中寻找指定路径的文件</td></tr></tbody></table><h2 id="编译阶段" tabindex="-1"><a class="header-anchor" href="#编译阶段" aria-hidden="true">#</a> 编译阶段</h2><table><thead><tr><th style="text-align:left;">事件名</th><th style="text-align:left;">注释</th></tr></thead><tbody><tr><td style="text-align:left;">run</td><td style="text-align:left;">启动一次新的编译</td></tr><tr><td style="text-align:left;">watch-run</td><td style="text-align:left;">和 run 类似，区别在于它是在监听模式下启动的编译，在这个事件中可以获取到是哪些文件发生了变化导致需要重新启动一次新的编译</td></tr><tr><td style="text-align:left;">compile</td><td style="text-align:left;">该事件是为了告诉插件一次新的编译将要启动，同时会给插件带上 compiler 对象</td></tr><tr><td style="text-align:left;">compilation</td><td style="text-align:left;">当 Webpack 以开发模式运行时，每当检测到文件变化，一次新的 Compilation 将被创建。一个 Compilation 对象包含了当前的模块资源、编译生成资源、变化的文件等。Compilation 对象也提供了很多事件回调供插件扩展</td></tr><tr><td style="text-align:left;">make</td><td style="text-align:left;">一个新的 Compilation 创建完毕，即将从 Entry 开始读取文件，根据文件类型和配置的 Loader 对文件进行编译，编译完后再找出该文件依赖的文件，递归地编译和解析</td></tr><tr><td style="text-align:left;">after-compile</td><td style="text-align:left;">一次 Compilation 执行完成</td></tr><tr><td style="text-align:left;">invalid</td><td style="text-align:left;">当遇到文件不存在、文件编译错误等异常时会触发该事件，该事件不会导致 Webpack 退出</td></tr></tbody></table><p>在编译阶段中，最重要的要数 compilation 事件了，因为在 compilation 阶段调用了 Loader 完成了每个模块的转换操作，在 compilation 阶段又包括很多小的事件，它们分别是：</p><table><thead><tr><th style="text-align:left;">事件名</th><th style="text-align:left;">解释</th></tr></thead><tbody><tr><td style="text-align:left;">build-module</td><td style="text-align:left;">使用对应的 Loader 去转换一个模块</td></tr><tr><td style="text-align:left;">normal-module-loader</td><td style="text-align:left;">使用 Loader 对一个模块转换完后，使用 acorn 解析转换后的内容，输出对应的抽象语法树(AST)，以方便 Webpack 后面对代码的分析</td></tr><tr><td style="text-align:left;">program</td><td style="text-align:left;">从配置的入口模块开始，分析其 AST，当遇到 require 等导入其他模块语句时，便将其加入到依赖的模块列表，同时对新找出的依赖模块递归分析，最终搞清楚所有模块的依赖关系</td></tr><tr><td style="text-align:left;">seal</td><td style="text-align:left;">所有模块及其依赖的模块都通过 Loader 转换完成后，根据依赖关系开始生成 Chunk</td></tr></tbody></table><h2 id="输出阶段" tabindex="-1"><a class="header-anchor" href="#输出阶段" aria-hidden="true">#</a> 输出阶段</h2><table><thead><tr><th style="text-align:left;">事件名</th><th style="text-align:left;">解释</th></tr></thead><tbody><tr><td style="text-align:left;">should-emit</td><td style="text-align:left;">所有需要输出的文件已经生成完毕，询问插件哪些文件需要输出，哪些不需要</td></tr><tr><td style="text-align:left;">emit</td><td style="text-align:left;">确定好要输出哪些文件后，执行文件输出，可以在这里获取和修改输出内容</td></tr><tr><td style="text-align:left;">after-emit</td><td style="text-align:left;">文件输出完毕</td></tr><tr><td style="text-align:left;">done</td><td style="text-align:left;">成功完成一次完成的编译和输出流程</td></tr><tr><td style="text-align:left;">failed</td><td style="text-align:left;">如果在编译和输出流程中遇到异常导致 Webpack 退出时，就会直接跳转到本步骤，插件可以在本事件中获取到具体的错误原因</td></tr></tbody></table><p>在输出阶段已经得到了各个模块经过转换后的结果和其依赖关系，并且把相关模块组合在一起形成一个个 Chunk。 在输出阶段会根据 Chunk 的类型，使用对应的模版生成最终要要输出的文件内容。</p><h2 id="输出文件分析" tabindex="-1"><a class="header-anchor" href="#输出文件分析" aria-hidden="true">#</a> 输出文件分析</h2><p>虽然在前面的章节中你学会了如何使用 Webpack ，也大致知道其工作原理，可是你想过 Webpack 输出的 bundle.js 是什么样子的吗？ 为什么原来一个个的模块文件被合并成了一个单独的文件？为什么 bundle.js 能直接运行在浏览器中？ 本节将解释清楚以上问题。</p><p>先来看看由 安装与使用 中最简单的项目构建出的 bundle.js 文件内容，代码如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// webpackBootstrap 启动函数</span>
<span class="token comment">// modules 即为存放所有模块的数组，数组中的每一个元素都是一个函数</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 安装过的模块都存放在这里面</span>
  <span class="token comment">// 作用是把已经加载过的模块缓存在内存中，提升性能</span>
  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 去数组中加载一个模块，moduleId 为要加载模块在数组中的 index</span>
  <span class="token comment">// 作用和 Node.js 中 require 语句相似</span>
  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果需要加载的模块已经被加载过，就直接从内存缓存中返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果缓存中不存在需要加载的模块，就新建一个模块，并把它存在缓存中</span>
    <span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">// 模块在数组中的 index</span>
      <span class="token literal-property property">i</span><span class="token operator">:</span> moduleId<span class="token punctuation">,</span>
      <span class="token comment">// 该模块是否已经加载完毕</span>
      <span class="token literal-property property">l</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token comment">// 该模块的导出值</span>
      <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从 modules 中获取 index 为 moduleId 的模块对应的函数</span>
    <span class="token comment">// 再调用这个函数，同时把函数需要的参数传入</span>
    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
      module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>
      module<span class="token punctuation">,</span>
      module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span>
      __webpack_require__
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 把这个模块标记为已加载</span>
    module<span class="token punctuation">.</span>l <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回这个模块的导出值</span>
    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Webpack 配置中的 publicPath，用于加载被分割出去的异步代码</span>
  __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

  <span class="token comment">// 使用 __webpack_require__ 去加载 index 为 0 的模块，并且返回该模块导出的内容</span>
  <span class="token comment">// index 为 0 的模块就是 main.js 对应的文件，也就是执行入口模块</span>
  <span class="token comment">// __webpack_require__.s 的含义是启动模块对应的 index</span>
  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
  <span class="token comment">// 所有的模块都存放在了一个数组里，根据每个模块在数组的 index 来区分和定位模块</span>
  <span class="token punctuation">[</span>
    <span class="token comment">/* 0 */</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通过 __webpack_require__ 规范导入 show 函数，show.js 对应的模块 index 为 1</span>
      <span class="token keyword">const</span> show <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 执行 show 函数</span>
      <span class="token function">show</span><span class="token punctuation">(</span><span class="token string">&quot;Webpack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">/* 1 */</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">function</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">&quot;Hello,&quot;</span> <span class="token operator">+</span> content<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 通过 CommonJS 规范导出 show 函数</span>
      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> show<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上看上去复杂的代码其实是一个立即执行函数，可以简写为如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 模拟 require 语句</span>
  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// 执行存放所有模块数组中的第0个模块</span>
  <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token comment">/*存放所有模块的数组*/</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>bundle.js 能直接运行在浏览器中的原因在于输出的文件中通过 <code>__webpack_require__</code> 函数定义了一个可以在浏览器中执行的加载函数来模拟 Node.js 中的 require 语句。</p><p>原来一个个独立的模块文件被合并到了一个单独的 bundle.js 的原因在于浏览器不能像 Node.js 那样快速地去本地加载一个个模块文件，而必须通过网络请求去加载还未得到的文件。 如果模块数量很多，加载时间会很长，因此把所有模块都存放在了数组中，执行一次网络加载。</p><p>如果仔细分析 <code>__webpack_require__</code> 函数的实现，你还有发现 Webpack 做了缓存优化： 执行加载过的模块不会再执行第二次，执行结果会缓存在内存中，当某个模块第二次被访问时会直接去内存中读取被缓存的返回值。</p><h2 id="分割代码时的输出" tabindex="-1"><a class="header-anchor" href="#分割代码时的输出" aria-hidden="true">#</a> 分割代码时的输出</h2><p>例如把源码中的 main.js 修改为如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 异步加载 show.js</span>
<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;./show&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">show</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 执行 show 函数</span>
  <span class="token function">show</span><span class="token punctuation">(</span><span class="token string">&quot;Webpack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重新构建后会输出两个文件，分别是执行入口文件 bundle.js 和 异步加载文件 0.bundle.js。</p><p>其中 0.bundle.js 内容如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 加载在本文件(0.bundle.js)中包含的模块</span>
<span class="token function">webpackJsonp</span><span class="token punctuation">(</span>
  <span class="token comment">// 在其它文件中存放着的模块的 ID</span>
  <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 本文件所包含的模块</span>
  <span class="token punctuation">[</span>
    <span class="token comment">// show.js 所对应的模块</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">function</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token string">&quot;Hello,&quot;</span> <span class="token operator">+</span> content<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> show<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>bundle.js 内容如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/***
   * webpackJsonp 用于从异步加载的文件中安装模块。
   * 把 webpackJsonp 挂载到全局是为了方便在其它文件中调用。
   *
   * <span class="token keyword">@param</span> <span class="token parameter">chunkIds</span> 异步加载的文件中存放的需要安装的模块对应的 Chunk ID
   * <span class="token keyword">@param</span> <span class="token parameter">moreModules</span> 异步加载的文件中存放的需要安装的模块列表
   * <span class="token keyword">@param</span> <span class="token parameter">executeModules</span> 在异步加载的文件中存放的需要安装的模块都安装成功后，需要执行的模块对应的 index
   */</span>
  window<span class="token punctuation">[</span><span class="token string">&quot;webpackJsonp&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">webpackJsonpCallback</span><span class="token punctuation">(</span>
    <span class="token parameter">chunkIds<span class="token punctuation">,</span>
    moreModules<span class="token punctuation">,</span>
    executeModules</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 把 moreModules 添加到 modules 对象中</span>
    <span class="token comment">// 把所有 chunkIds 对应的模块都标记成已经加载成功</span>
    <span class="token keyword">var</span> moduleId<span class="token punctuation">,</span>
      chunkId<span class="token punctuation">,</span>
      i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
      resolves <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      result<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunkIds<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      chunkId <span class="token operator">=</span> chunkIds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        resolves<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>moreModules<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>resolves<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resolves<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 缓存已经安装的模块</span>
  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 存储每个 Chunk 的加载状态；</span>
  <span class="token comment">// 键为 Chunk 的 ID，值为0代表已经加载成功</span>
  <span class="token keyword">var</span> installedChunks <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token number">1</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 模拟 require 语句，和上面介绍的一致</span>
  <span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... 省略和上面一样的内容</span>
  <span class="token punctuation">}</span>

  <span class="token doc-comment comment">/**
   * 用于加载被分割出去的，需要异步加载的 Chunk 对应的文件
   * <span class="token keyword">@param</span> <span class="token parameter">chunkId</span> 需要异步加载的 Chunk 对应的 ID
   * <span class="token keyword">@returns</span> <span class="token class-name"><span class="token punctuation">{</span>Promise<span class="token punctuation">}</span></span>
   */</span>
  __webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">e</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">requireEnsure</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 从上面定义的 installedChunks 中获取 chunkId 对应的 Chunk 的加载状态</span>
    <span class="token keyword">var</span> installedChunkData <span class="token operator">=</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果加载状态为0表示该 Chunk 已经加载成功了，直接返回 resolve Promise</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunkData <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// installedChunkData 不为空且不为0表示该 Chunk 正在网络加载中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedChunkData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 返回存放在 installedChunkData 数组中的 Promise 对象</span>
      <span class="token keyword">return</span> installedChunkData<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// installedChunkData 为空，表示该 Chunk 还没有加载过，去加载该 Chunk 对应的文件</span>
    <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      installedChunkData <span class="token operator">=</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    installedChunkData<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> promise<span class="token punctuation">;</span>

    <span class="token comment">// 通过 DOM 操作，往 HTML head 中插入一个 script 标签去异步加载 Chunk 对应的 JavaScript 文件</span>
    <span class="token keyword">var</span> head <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">&quot;head&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;script&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;text/javascript&quot;</span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>charset <span class="token operator">=</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token number">120000</span><span class="token punctuation">;</span>

    <span class="token comment">// 文件的路径为配置的 publicPath、chunkId 拼接而成</span>
    script<span class="token punctuation">.</span>src <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">&quot;.bundle.js&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置异步加载的最长超时时间</span>
    <span class="token keyword">var</span> timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>onScriptComplete<span class="token punctuation">,</span> <span class="token number">120000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    script<span class="token punctuation">.</span>onerror <span class="token operator">=</span> script<span class="token punctuation">.</span>onload <span class="token operator">=</span> onScriptComplete<span class="token punctuation">;</span>

    <span class="token comment">// 在 script 加载和执行完成时回调</span>
    <span class="token keyword">function</span> <span class="token function">onScriptComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 防止内存泄露</span>
      script<span class="token punctuation">.</span>onerror <span class="token operator">=</span> script<span class="token punctuation">.</span>onload <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 去检查 chunkId 对应的 Chunk 是否安装成功，安装成功时才会存在于 installedChunks 中</span>
      <span class="token keyword">var</span> chunk <span class="token operator">=</span> installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          chunk<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Loading chunk &quot;</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">&quot; failed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> promise<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 加载并执行入口模块，和上面介绍的一致</span>
  <span class="token keyword">return</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>
  <span class="token comment">// 存放所有没有经过异步加载的，随着执行入口文件加载的模块</span>
  <span class="token punctuation">[</span>
    <span class="token comment">// main.js 对应的模块</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 通过 __webpack_require__.e 去异步加载 show.js 对应的 Chunk</span>
      __webpack_require__
        <span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">__webpack_require__</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">show</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 执行 show 函数</span>
          <span class="token function">show</span><span class="token punctuation">(</span><span class="token string">&quot;Webpack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的 bundle.js 和上面所讲的 bundle.js 非常相似，区别在于</p><ul><li>多了一个 <code>__webpack_require__.e</code> 用于加载被分割出去的，需要异步加载的 Chunk 对应的文件;</li><li>多了一个 webpackJsonp 函数用于从异步加载的文件中安装模块。</li></ul><p>在使用了 CommonsChunkPlugin 去提取公共代码时输出的文件和使用了异步加载时输出的文件是一样的，都会有 <code>__webpack_require__.e</code> 和 webpackJsonp。 原因在于提取公共代码和异步加载本质上都是代码分割</p><h2 id="简析-loader" tabindex="-1"><a class="header-anchor" href="#简析-loader" aria-hidden="true">#</a> 简析 Loader</h2><p>Loader 就像是一个翻译员，能把源文件经过转化后输出新的结果，并且一个文件还可以链式的经过多个翻译员翻译</p><p>以处理 SCSS 文件为例：</p><ul><li>SCSS 源代码会先交给 sass-loader 把 SCSS 转换成 CSS；</li><li>把 sass-loader 输出的 CSS 交给 css-loader 处理，找出 CSS 中依赖的资源、压缩 CSS 等；</li><li>把 css-loader 输出的 CSS 交给 style-loader 处理，转换成通过脚本加载的 JavaScript 代码；</li></ul><p>可以看出以上的处理过程需要有顺序的链式执行，先 sass-loader 再 css-loader 再 style-loader</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token comment">// 增加对 SCSS 文件的支持</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.scss</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token comment">// SCSS 文件的处理顺序为先 sass-loader 再 css-loader 再 style-loader</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">&quot;style-loader&quot;</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">,</span>
            <span class="token comment">// 给 css-loader 传入配置项</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token literal-property property">minimize</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">&quot;sass-loader&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所以不难看出，一个 loader 的职责是单一的，只需要完成一种转换。 如果一个源文件需要经历多步转换才能正常使用，就通过多个 Loader 去转换。 在调用多个 Loader 去转换一个文件时，每个 Loader 会链式的顺序执行， 第一个 Loader 将会拿到需处理的原内容，上一个 Loader 处理后的结果会传给下一个接着处理，最后的 Loader 将处理后的最终结果返回给 Webpack。</p><h2 id="plugin" tabindex="-1"><a class="header-anchor" href="#plugin" aria-hidden="true">#</a> Plugin</h2><p>Webpack 通过 Plugin 机制让其更加灵活，以适应各种应用场景。 在 Webpack 运行的生命周期中会广播出许多事件，Plugin 可以监听这些事件，在合适的时机通过 Webpack 提供的 API 改变输出结果</p><p>一个最基础的 Plugin 的代码是这样的</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">BasicPlugin</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在构造函数中获取用户给该插件传入的配置</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// Webpack 会调用 BasicPlugin 实例的 apply 方法给插件实例传入 compiler 对象</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&quot;compilation&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 导出 Plugin</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> BasicPlugin<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> BasicPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./BasicPlugin.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>export <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">BasicPlugin</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Webpack 启动后，在读取配置的过程中会先执行 new BasicPlugin(options) 初始化一个 BasicPlugin 获得其实例。 在初始化 compiler 对象后，再调用 basicPlugin.apply(compiler) 给插件实例传入 compiler 对象。 插件实例在获取到 compiler 对象后，就可以通过 compiler.plugin(事件名称, 回调函数) 监听到 Webpack 广播出来的事件。 并且可以通过 compiler 对象去操作 Webpack。</p><h2 id="complier-和-compilation" tabindex="-1"><a class="header-anchor" href="#complier-和-compilation" aria-hidden="true">#</a> Complier 和 Compilation</h2><p>在开发 Plugin 时最常用的两个对象就是 Compiler 和 Compilation，它们是 Plugin 和 Webpack 之间的桥梁。 Compiler 和 Compilation 的含义如下：</p><ul><li>Compiler 对象包含了 Webpack 环境所有的的配置信息，包含 options，loaders，plugins 这些信息，这个对象在 Webpack 启动时候被实例化，它是全局唯一的，可以简单地把它理解为 Webpack 实例；</li><li>Compilation 对象包含了当前的模块资源、编译生成资源、变化的文件等。当 Webpack 以开发模式运行时，每当检测到一个文件变化，一次新的 Compilation 将被创建。Compilation 对象也提供了很多事件回调供插件做扩展。通过 Compilation 也能读取到 Compiler 对象。</li></ul><p>Compiler 和 Compilation 的区别在于：Compiler 代表了整个 Webpack 从启动到关闭的生命周期，而 Compilation 只是代表了一次新的编译。</p><h2 id="事件流" tabindex="-1"><a class="header-anchor" href="#事件流" aria-hidden="true">#</a> 事件流</h2><p>Webpack 就像一条生产线，要经过一系列处理流程后才能将源文件转换成输出结果。 这条生产线上的每个处理流程的职责都是单一的，多个流程之间有存在依赖关系，只有完成当前处理后才能交给下一个流程去处理。 插件就像是一个插入到生产线中的一个功能，在特定的时机对生产线上的资源做处理。</p><p>Webpack 通过 Tapable 来组织这条复杂的生产线。 Webpack 在运行过程中会广播事件，插件只需要监听它所关心的事件，就能加入到这条生产线中，去改变生产线的运作。 Webpack 的事件流机制保证了插件的有序性，使得整个系统扩展性很好。</p><p>Webpack 的事件流机制应用了观察者模式，和 Node.js 中的 EventEmitter 非常相似。Compiler 和 Compilation 都继承自 Tapable，可以直接在 Compiler 和 Compilation 对象上广播和监听事件，方法如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token doc-comment comment">/**
 * 广播出事件
 * event-name 为事件名称，注意不要和现有的事件重名
 * params 为附带的参数
 */</span>
<span class="token function">compiler</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">&quot;event-name&quot;</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 监听名称为 event-name 的事件，当 event-name 事件发生时，函数就会被执行。
 * 同时函数中的 params 参数为广播事件时附带的参数。
 */</span>
compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&quot;event-name&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同理，compilation.apply 和 compilation.plugin 使用方法和上面一致。</p><p>在开发插件时，还需要注意以下三点：</p><ul><li>只要能拿到 Compiler 或 Compilation 对象，就能广播出新的事件，所以在新开发的插件中也能广播出事件，给其它插件监听使用。</li><li>传给每个插件的 Compiler 和 Compilation 对象都是同一个引用。也就是说在一个插件中修改了 Compiler 或 Compilation 对象上的属性，会影响到后面的插件。</li><li>有些事件是异步的，这些异步的事件会附带两个参数，第二个参数为回调函数，在插件处理完任务时需要调用回调函数通知 Webpack，才会进入下一处理流程。例如：</li></ul><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&quot;emit&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 支持处理逻辑</span>

  <span class="token comment">// 处理完毕后执行 callback 以通知 Webpack</span>
  <span class="token comment">// 如果不执行 callback，运行流程将会一直卡在这不往下执行</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="修改输出资源" tabindex="-1"><a class="header-anchor" href="#修改输出资源" aria-hidden="true">#</a> 修改输出资源</h2><p>有些场景下插件需要修改、增加、删除输出的资源，要做到这点需要监听 emit 事件，因为发生 emit 事件时所有模块的转换和代码块对应的文件已经生成好， 需要输出的资源即将输出，因此 emit 事件是修改 Webpack 输出资源的最后时机。</p><p>所有需要输出的资源会存放在 compilation.assets 中，compilation.assets 是一个键值对，键为需要输出的文件名称，值为文件对应的内容。</p><p>设置 compilation.assets 的代码如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&quot;emit&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 设置名称为 fileName 的输出资源</span>
  compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>fileName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回文件内容</span>
    <span class="token function-variable function">source</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// fileContent 既可以是代表文本文件的字符串，也可以是代表二进制文件的 Buffer</span>
      <span class="token keyword">return</span> fileContent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 返回文件大小</span>
    <span class="token function-variable function">size</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>读取 compilation.assets 的代码如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&quot;emit&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 读取名称为 fileName 的输出资源</span>
  <span class="token keyword">const</span> asset <span class="token operator">=</span> compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>fileName<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取输出资源的内容</span>
  asset<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取输出资源的文件大小</span>
  asset<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="内存系统打包" tabindex="-1"><a class="header-anchor" href="#内存系统打包" aria-hidden="true">#</a> 内存系统打包</h2><p>Webpack 在 dev 模式下打包文件是临时贮存在内存中的，其主要借助 memory-fs 内存文件系统实现</p><h3 id="memory-fs" tabindex="-1"><a class="header-anchor" href="#memory-fs" aria-hidden="true">#</a> memory-fs</h3><p>memory-fs 是 NodeJS 原生 fs 模块内存版(in-memory)的完整功能实现。相比于从磁盘读写数据，memory-fs 是内存缓存和快速数据处理的完美替代方案</p><p>webpack 通过自己实现的 memory-fs 将 bundle.js 文件打包到了内存中，访问内存中的代码文件也就更快，也减少了代码写入文件的开销</p><p>memory-fs 是 webpack-dev-middleware 的一个依赖库，webpack-dev-middleware 将 webpack 原本的 outputFileSystem (node 的 fs 系统)替换成了 MemoryFileSystem 实例，这样代码就将输出到内存中。webpack-dev-middleware 中该部分源码如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// webpack-dev-middleware/lib/Shared.js</span>
<span class="token keyword">var</span> isMemoryFs <span class="token operator">=</span>
  <span class="token operator">!</span>compiler<span class="token punctuation">.</span>compilers <span class="token operator">&amp;&amp;</span> compiler<span class="token punctuation">.</span>outputFileSystem <span class="token keyword">instanceof</span> <span class="token class-name">MemoryFileSystem</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isMemoryFs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fs <span class="token operator">=</span> compiler<span class="token punctuation">.</span>outputFileSystem<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  fs <span class="token operator">=</span> compiler<span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryFileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="简单实现" tabindex="-1"><a class="header-anchor" href="#简单实现" aria-hidden="true">#</a> 简单实现</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 通过键值对形式存储进new MemoryFileSystem().data对象中</span>
<span class="token keyword">var</span> MemoryFileSystem <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./MemoryFileSystem&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryFileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Optionally pass a javascript object</span>
<span class="token keyword">const</span> fs2 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//创建 /tmp/a/apple 目录，不管 `/tmp` 和 /tmp/a 目录是否存在。 node v10的版本才有</span>
fs2<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">&quot;/tmp/a/apple&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">recursive</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">mkdirpSync</span><span class="token punctuation">(</span><span class="token string">&quot;/a/test/dir&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;/a/test/dir/file2.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello World2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;/a/test/dir/file2.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// returns Buffer(&quot;Hello World&quot;))</span>
<span class="token comment">// fs.readFileSync(&quot;/a/test/dir/file2.txt&quot;,function(err,data) {</span>
<span class="token comment">//     console.log(data);</span>
<span class="token comment">// })</span>

fs2<span class="token punctuation">.</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">&quot;ass/dasdsa&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">recursive</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="hmr" tabindex="-1"><a class="header-anchor" href="#hmr" aria-hidden="true">#</a> HMR</h2><p>在 HMR 之前，应用的加载、更新是一种页面级别的原子操作，即使只是单个代码文件发生变更都需要刷新整个页面才能最新代码映射到浏览器上，这会丢失之前在页面执行过的所有交互与状态，例如：</p><p>对于复杂表单场景，这意味着你可能需要重新填充非常多字段信息</p><p>弹框消失，你必须重新执行交互动作才会重新弹出</p><p>再小的改动，例如更新字体大小，改变备注信息都会需要整个页面重新加载执行，影响开发体验。引入 HMR 后，虽然无法覆盖所有场景，但大多数小改动都可以实时热更新到页面上，从而确保连续、顺畅的开发调试体验，对开发效率有较大增益效果。</p><h3 id="hmr-配置" tabindex="-1"><a class="header-anchor" href="#hmr-配置" aria-hidden="true">#</a> HMR 配置</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 必须设置 devServer.hot = true，启动 HMR 功能</span>
    <span class="token literal-property property">hot</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="工作原理图解" tabindex="-1"><a class="header-anchor" href="#工作原理图解" aria-hidden="true">#</a> 工作原理图解</h3><p><img src="https://misaka10032.oss-cn-chengdu.aliyuncs.com/Webpack/webpack-hmr.webp" alt="webpack-hmr" loading="lazy"></p><p>上图是 webpack 配合 webpack-dev-server 进行应用开发的模块热更新流程图</p><ul><li>上图底部红色框内是服务端，而上面的橙色框是浏览器端。</li><li>绿色的方框是 webpack 代码控制的区域。蓝色方框是 webpack-dev-server 代码控制的区域，洋红色的方框是文件系统，文件修改后的变化就发生在这，而青色的方框是应用本身。</li></ul><p>上图显示了我们修改代码到模块热更新完成的一个周期，通过深绿色的阿拉伯数字符号已经将 HMR 的整个过程标识了出来</p><ol><li>第一步，在 webpack 的 watch 模式下，文件系统中某一个文件发生修改，webpack 监听到文件变化，根据配置文件对模块重新编译打包，并将打包后的代码通过简单的 JavaScript 对象保存在内存中。</li><li>第二步是 webpack-dev-server 和 webpack 之间的接口交互，而在这一步，主要是 dev-server 的中间件 webpack-dev-middleware 和 webpack 之间的交互，webpack-dev-middleware 调用 webpack 暴露的 API 对代码变化进行监控，并且告诉 webpack，将代码打包到内存中。</li><li>第三步是 webpack-dev-server 对文件变化的一个监控，这一步不同于第一步，并不是监控代码变化重新打包。当我们在配置文件中配置了 devServer.watchContentBase 为 true 的时候，Server 会监听这些配置文件夹中静态文件的变化，变化后会通知浏览器端对应用进行 live reload。注意，这儿是浏览器刷新，和 HMR 是两个概念。</li><li>第四步也是 webpack-dev-server 代码的工作，该步骤主要是通过 sockjs（webpack-dev-server 的依赖）在浏览器端和服务端之间建立一个 websocket 长连接，将 webpack 编译打包的各个阶段的状态信息告知浏览器端，同时也包括第三步中 Server 监听静态文件变化的信息。浏览器端根据这些 socket 消息进行不同的操作。当然服务端传递的最主要信息还是新模块的 hash 值，后面的步骤根据这一 hash 值来进行模块热替换。</li><li>webpack-dev-server/client 端并不能够请求更新的代码，也不会执行热更模块操作，而把这些工作又交回给了 webpack，webpack/hot/dev-server 的工作就是根据 webpack-dev-server/client 传给它的信息以及 dev-server 的配置决定是刷新浏览器呢还是进行模块热更新。当然如果仅仅是刷新浏览器，也就没有后面那些步骤了。</li><li>HotModuleReplacement.runtime 是客户端 HMR 的中枢，它接收到上一步传递给他的新模块的 hash 值，它通过 JsonpMainTemplate.runtime 向 server 端发送 Ajax 请求，服务端返回一个 json，该 json 包含了所有要更新的模块的 hash 值，获取到更新列表后，该模块再次通过 jsonp 请求，获取到最新的模块代码。这就是上图中 7、8、9 步骤。</li><li>而第 10 步是决定 HMR 成功与否的关键步骤，在该步骤中，HotModulePlugin 将会对新旧模块进行对比，决定是否更新模块，在决定更新模块后，检查模块之间的依赖关系，更新模块的同时更新模块间的依赖引用。</li><li>最后一步，当 HMR 失败后，回退到 live reload 操作，也就是进行浏览器刷新来获取最新打包代码。</li></ol><p>接下来，分六步对上述过程进行详解</p><h3 id="第一步-文件系统监听并打包" tabindex="-1"><a class="header-anchor" href="#第一步-文件系统监听并打包" aria-hidden="true">#</a> 第一步：文件系统监听并打包</h3><p>webpack-dev-middleware 调用 webpack 的 api 对文件系统 watch，当 hello.js 文件发生改变后，webpack 重新对文件进行编译打包，然后保存到内存中</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// webpack-dev-middleware/lib/Shared.js</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> watching <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>
    options<span class="token punctuation">.</span>watchOptions<span class="token punctuation">,</span>
    share<span class="token punctuation">.</span>handleCompilerCallback
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>watching <span class="token operator">=</span> watching<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>文件内存系统的分析详见<a href="#%E5%86%85%E5%AD%98%E7%B3%BB%E7%BB%9F%E6%89%93%E5%8C%85">文件内存系统</a></p><p>实现该功能后，浏览器请求 bundle.js 文件的实质就变成了向 devServer 请求 js 对象，返回给浏览器端</p><h3 id="第二步-文件内容改变" tabindex="-1"><a class="header-anchor" href="#第二步-文件内容改变" aria-hidden="true">#</a> 第二步：文件内容改变</h3><p>这一阶段，sockjs 是服务端和客户端的桥梁，启动 devServer 的时候，sockjs 在服务端和客户端建立了一个 webSocket 长连接，以便将编译和打包各阶段状态告知客户端，最关键的步骤还是 webpack-dev-server 调用 webpack api 监听 compile 的 done 事件，当 compile 完成后，webpack-dev-server 通过 <code>_sendStatus</code> 方法将编译打包后的<strong>新模块 hash 值</strong>发送到浏览器端</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// webpack-dev-server/lib/Server.js</span>
compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&#39;done&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// stats.hash 是最新打包文件的 hash 值</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_sendStats</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sockets<span class="token punctuation">,</span> stats<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>clientStats<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_stats <span class="token operator">=</span> stats<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token class-name">Server</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_sendStats</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">sockets<span class="token punctuation">,</span> stats<span class="token punctuation">,</span> force</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>force <span class="token operator">&amp;&amp;</span> stats <span class="token operator">&amp;&amp;</span>
  <span class="token punctuation">(</span><span class="token operator">!</span>stats<span class="token punctuation">.</span>errors <span class="token operator">||</span> stats<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> stats<span class="token punctuation">.</span>assets <span class="token operator">&amp;&amp;</span>
  stats<span class="token punctuation">.</span>assets<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token parameter">asset</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>asset<span class="token punctuation">.</span>emitted<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">&#39;still-ok&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token comment">// 调用 sockWrite 方法将 hash 值通过 websocket 发送到浏览器端</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">&#39;hash&#39;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">&#39;errors&#39;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>warnings<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">&#39;warnings&#39;</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>warnings<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>      <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">&#39;ok&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="第三步-客户端接收并响应" tabindex="-1"><a class="header-anchor" href="#第三步-客户端接收并响应" aria-hidden="true">#</a> 第三步：客户端接收并响应</h3><p>客户端能接受 websocket 消息的原理是：webpack-dev-server 修改了 webpack 配置中的 entry 属性，在里面添加了 webpack-dev-client 的代码，这样在最后的 bundle.js 文件中就会有接收 websocket 消息的代码了。注入的 HMR Runtime 包括：</p><ul><li>用于建立 Websocket 连接，处理 hash 等消息的运行时代码</li><li>用于加载热更新资源的 RuntimeGlobals.hmrDownloadManifest 与 RuntimeGlobals.hmrDownloadUpdateHandlers 接口</li><li>用于处理模块更新策略的 module.hot.accept 接口</li><li>……</li></ul><p>webpack-dev-server/client 当接收到 type 为 hash 消息后会将 hash 值暂存起来，当接收到 type 为 ok 的消息后对应用执行 reload 操作</p><p>在 reload 操作中，webpack-dev-server/client 会根据 hot 配置决定是刷新浏览器还是对代码进行热更新（HMR）</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// webpack-dev-server/client/index.js</span>
<span class="token function-variable function">hash</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">msgHash</span><span class="token punctuation">(</span><span class="token parameter">hash</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentHash <span class="token operator">=</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function-variable function">ok</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">msgOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// ...</span>
<span class="token keyword">function</span> <span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;[WDS] App hot update...&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> hotEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack/hot/emitter&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hotEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;webpackHotUpdate&#39;</span><span class="token punctuation">,</span> currentHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#39;[WDS] App updated. Reloading...&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    self<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如上面代码所示，首先将 hash 值暂存到 currentHash 变量，当接收到 ok 消息后，对 App 进行 reload。如果配置了模块热更新，就调用 webpack/hot/emitter 将最新 hash 值发送给 webpack，然后将控制权交给 webpack 客户端代码。如果没有配置模块热更新，就直接调用 location.reload 方法刷新页面</p><h3 id="第四步-hash-验证及请求代码" tabindex="-1"><a class="header-anchor" href="#第四步-hash-验证及请求代码" aria-hidden="true">#</a> 第四步：hash 验证及请求代码</h3><p>在这一步，其实是 webpack 中三个模块（三个文件，后面英文名对应文件路径）之间配合的结果</p><p><img src="https://misaka10032.oss-cn-chengdu.aliyuncs.com/Webpack/websocket-hmr.png" alt="websocket-hmr时序图" loading="lazy"></p><p>首先是 webpack/hot/dev-server（以下简称 dev-server） 监听第三步 webpack-dev-server/client 发送的 webpackHotUpdate 消息</p><p>调用 webpack/lib/HotModuleReplacement.runtime（简称 HMR runtime）中的 check 方法，检测是否有新的更新</p><p>在 check 过程中会利用 webpack/lib/JsonpMainTemplate.runtime（简称 jsonp runtime）中的两个方法 hotDownloadUpdateChunk 和 hotDownloadManifest</p><p>第二个方法是调用 AJAX 向服务端请求是否有更新的文件，如果有将发更新的文件列表返回客户端</p><p>而第一个方法是通过 jsonp 请求最新的模块代码，然后将代码返回给 HMR runtime，HMR runtime 会根据返回的新模块代码做进一步处理，可能是刷新页面，也可能是对模块进行热更新</p><p>值得注意的是，两次请求的都是使用上一次的 hash 值拼接的请求文件名，hotDownloadManifest 方法返回的是最新的 hash 值，hotDownloadUpdateChunk 方法返回的就是最新 hash 值对应的代码块。然后将新的代码块返回给 HMR runtime，进行模块热更新</p><p>注意，在这里各方功能实现了解耦</p><ol><li>websocket 实现的是 webpack-dev-server 的客户端和服务端的通信，它们之间传递的是更新文件的 hash 值而不是代码信息</li><li>webpack/hot/dev-server 负责监听 websocket 信息变化</li><li>webpack/lib/HotModuleReplacement.runtime 调用更新检测</li><li>webpack/lib/JsonpMainTemplate.runtime 调用请求获取更新的文件 or 模块代码</li></ol><h3 id="第五步-模块热更新" tabindex="-1"><a class="header-anchor" href="#第五步-模块热更新" aria-hidden="true">#</a> 第五步：模块热更新</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// webpack/lib/HotModuleReplacement.runtime</span>
<span class="token keyword">function</span> <span class="token function">hotApply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">var</span> idx<span class="token punctuation">;</span>
  <span class="token keyword">var</span> queue <span class="token operator">=</span> outdatedModules<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    moduleId <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// remove module from cache</span>
    <span class="token keyword">delete</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// when disposing there is no need to call dispose handler</span>
    <span class="token keyword">delete</span> outdatedDependencies<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// remove &quot;parents&quot; references from all children</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> module<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> child <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>module<span class="token punctuation">.</span>children<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
      idx <span class="token operator">=</span> child<span class="token punctuation">.</span>parents<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        child<span class="token punctuation">.</span>parents<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// insert new code</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> appliedUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>appliedUpdate<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> appliedUpdate<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从上面 hotApply 方法可以看出，模块热替换主要分三个阶段</p><p>第一个阶段是找出 outdatedModules 和 outdatedDependencies</p><p>第二个阶段从缓存中删除过期的模块和依赖</p><p>第三个阶段是将新的模块添加到 modules 中，当下次调用 <code>__webpack_require__</code> (webpack 重写的 require 方法)方法的时候，就是获取到了新的模块代码了</p><p>模块热更新的错误处理，如果在热更新过程中出现错误，热更新将回退到刷新浏览器，这部分代码在 dev-server 代码中，作为 HMR 的失败兜底策略</p><p>dev-server 先验证是否有更新，没有代码更新的话，重载浏览器。如果在 hotApply 的过程中出现 abort 或者 fail 错误，也进行重载浏览器</p><h3 id="第六步-业务代码执行" tabindex="-1"><a class="header-anchor" href="#第六步-业务代码执行" aria-hidden="true">#</a> 第六步：业务代码执行</h3><p>当用新的模块代码替换老的模块后，但是我们的业务代码并不能知道代码已经发生变化，也就是说，当 hello.js 文件修改后，我们需要在 index.js 文件中调用 HMR 的 accept 方法，添加模块更新后的处理函数，及时将 hello 方法的返回值插入到页面中。代码如下：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// index.js</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string">&quot;./hello.js&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：在 Webpack HMR 框架中，module.hot.accept 函数只能捕获当前模块对应子孙模块的更新事件，不支持反向 or 跨子树传递，与事件冒泡过程基本相似</p><h3 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h3><p>最后再回顾一下，Webpack 的 HMR 特性有两个重点，一是监听文件变化并通过 WebSocket 发送变更消息;二是需要客户端提供配合，通过 module.hot.accept 接口明确告知 Webpack 如何执行代码替换</p><h2 id="tree-shaking" tabindex="-1"><a class="header-anchor" href="#tree-shaking" aria-hidden="true">#</a> Tree Shaking</h2><p>Webpack 在 v5 版本之后已经开始广泛使用 Tree Shaking 这一技术</p><p>Tree-Shaking 是一种基于 ES Module 规范的 Dead Code Elimination 技术，它会在运行过程中静态分析模块之间的导入导出，确定 ESM 模块中哪些导出值未被其它模块使用，并将其删除，以此实现打包产物的优化</p><p>参考链接 1：<a href="https://zhuanlan.zhihu.com/p/472733451" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/472733451<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>参考链接 2：<a href="https://blog.csdn.net/qiwoo_weekly/article/details/120072705" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/qiwoo_weekly/article/details/120072705<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="dead-code" tabindex="-1"><a class="header-anchor" href="#dead-code" aria-hidden="true">#</a> Dead Code</h3><p>Tree Shaking 的本质实际上是为了消除无用的 js 代码（Dead Code），减少加载文件体积，使其整体执行时间更短</p><p>Dead Code 的定义如下：</p><ul><li>代码不可到达，不会执行</li><li>代码执行的结果不会被用到</li><li>代码中某变量只有写，没有读操作</li></ul><h3 id="实现前提" tabindex="-1"><a class="header-anchor" href="#实现前提" aria-hidden="true">#</a> 实现前提</h3><p>Webpack 实现 Tree Shaking 是有前提的：</p><ul><li>Tree Shaking 的执行环境宿主一般是 Node 而不是浏览器</li><li>若 JavaScript 是模块化的，那么必须遵循 ES6 Module 规范，而不是 CommonJS 或其他，主要是因为 ES6 Module 可以静态分析的，而在 CommonJs、AMD、CMD 等旧版本的 JavaScript 模块化方案中，导入导出行为是高度动态，难以预测的</li><li>通过作用域分析，分析出代码里变量所属的作用域以及他们之间的引用关系，进而可以推导出变量和导入依赖变量的引用关系</li><li>将 mode 选项为&quot;production&quot;，以启用 tree shaking 和 minification （代码压缩）</li><li>确保没有把 compiler 将 es6 模块语法转换为 CommonJS 模块。这一块很重要，在你使用 babel-loader 或者 ts-loader 编译代码时，一定要保留 import 和 export</li></ul><h3 id="实现原理" tabindex="-1"><a class="header-anchor" href="#实现原理" aria-hidden="true">#</a> 实现原理</h3><p>首先，Tree-Shaking 分两大步：</p><ol><li>「标记」出模块导出值，看哪些没有被使用过</li><li>使用 Terser「删除」掉没有用到的导出语句</li></ol><p>第一步又分三个步骤：</p><ol><li>Make 阶段，收集导出变量并记录到模块依赖图 ModuleGraph 变量中</li><li>Seal 阶段，遍历 ModuleGraph 标记模块导出变量有没有被使用</li><li>生成产物时，若变量没有被其他模块使用时则删除对应的导出语句</li></ol><h3 id="标记效果" tabindex="-1"><a class="header-anchor" href="#标记效果" aria-hidden="true">#</a> 标记效果</h3><p>webpack 负责对代码进行标记，把 import &amp; export 标记为 3 类：</p><ul><li>所有 import 标记为 <code>/* harmony import */</code></li><li>被使用过的 export 标记为<code>/* harm export([type])*/</code> ，其中<code>[type]</code> 和 webpack 内部相关，可能是 binding，immutable 等等。</li><li>未被使用过的 import 标记为 <code>/* unused harmony export [FuncName] */</code>，其中<code>[FuncName]</code> 为 export 的方法名称</li></ul><p><a href="https://misaka10032.oss-cn-chengdu.aliyuncs.com/Webpack/tree-shaking.jpg" target="_blank" rel="noopener noreferrer">实例说明<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>以上图为例：</p><p>bye 没有被使用，被标记为 <code>/* unused harmony export bye*/</code></p><p>hello 被使用为正常的 <code>/*harmony export(imutable) */</code></p><p>标记完成后，使用 Terser 直接清除并压缩代码</p><h3 id="副作用" tabindex="-1"><a class="header-anchor" href="#副作用" aria-hidden="true">#</a> 副作用</h3><p>副作用是函数式编程的一个概念，是指当调用函数时，除了返回函数值之外，还会对调用函数产生附加的影响</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">setTitle</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//</span>
  document<span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">&quot;xxx&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以上可知，虽然 a 变量没有被其他地方使用，但由于副作用，如果将其删除。</p><p>会导致 document.title 没有成功被设置导致出现 bug。</p><p>造成这一结果，浅层原因是 Webpack 的 Tree Shaking 逻辑停留在代码静态分析层面，只是浅显地判断：</p><ul><li>模块导出变量是否被其它模块引用</li><li>引用模块的主体代码中有没有出现这个变量</li></ul><p>没有进一步，从语义上分析模块导出值是不是真的被有效使用。</p><p>更深层次的原因则是 JavaScript 的赋值语句并不「纯」，视具体场景有可能产生意料之外的副作用，例如：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> bar<span class="token punctuation">,</span> foo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./bar&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> mock <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>mock<span class="token punctuation">,</span> <span class="token string">&quot;f&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">set</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mock<span class="token punctuation">.</span>_f <span class="token operator">=</span> v<span class="token punctuation">;</span>
    count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

mock<span class="token punctuation">.</span>f <span class="token operator">=</span> foo<span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例中，对 mock 对象施加的 Object.defineProperty 调用，导致 mock.f = foo 赋值语句对 count 变量产生了副作用，这种场景下即使用复杂的动态语义分析也很难在确保正确副作用的前提下，完美地 Shaking 掉所有无用的代码枝叶。</p><p>因此，在使用 Webpack 时开发者需要有意识地规避这些无意义的重复赋值操作</p><h3 id="副作用规避" tabindex="-1"><a class="header-anchor" href="#副作用规避" aria-hidden="true">#</a> 副作用规避</h3><ol><li>使用<code>#pure</code>标注纯函数调用</li></ol><p>与赋值语句类似，JavaScript 中的函数调用语句也可能产生副作用，因此默认情况下 Webpack 并不会对函数调用做 Tree Shaking 操作。不过，开发者可以在调用语句前添加 /<em>#<strong>PURE</strong></em>/ 备注，明确告诉 Webpack 该次函数调用并不会对上下文环境产生副作用，例如：</p><p><img src="https://misaka10032.oss-cn-chengdu.aliyuncs.com/Webpack/sideEffect-1.png" alt="副作用规避1" loading="lazy"></p><p>示例中，foo(&#39;be retained&#39;) 调用没有带上 /<em>#<strong>PURE</strong></em>/ 备注，代码被保留；作为对比，foo(&#39;be removed&#39;) 带上 Pure 声明后则被 Tree Shaking 删除</p><ol start="2"><li>禁止 Babel 转译模块导入导出语句</li></ol><p>Babel 是一个非常流行的 JS 代码转换器，允许将 ES6+的代码优雅降级为 ES5，但它提供的部分功能会使 Tree Shaking 失效，比如 Babel 将 ESM 风格语句转译为 CJS 风格语句，就会导致静态分析失效</p><p>因此，在 Webpack 中使用 babel-loader 时，建议将 babel-preset-env 的 modules 设置为 false，关闭模块导入导出语句的转译</p><ol start="3"><li>优化导出值的粒度</li></ol><p>Tree Shaking 逻辑作用在 ESM 的 export 语句上，因此对于下面这种导出场景：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bar</span><span class="token operator">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>即使实际上只用到 default 导出值的其中一个属性，整个 default 对象依然会被完整保留。所以实际开发中，应该尽量保持导出值颗粒度和原子性，上例代码的优化版本：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> bar<span class="token punctuation">,</span> foo <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>使用支持 TreeShaking 的包</li></ol><p>如果可以的话，应尽量使用支持 Tree Shaking 的 npm 包</p><p>例如，使用 lodash-es 替代 lodash，或者使用 babel-plugin-lodash 实现类似效果</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/mi-saka10032/frontend-service-station/edit/main/demo/theme-docs/src/webpack/4-webpack原理.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">上次编辑于: </span><!----></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: misaka10032@aliyun.com">yuzhihang</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/frontend-service-station/webpack/3-senior.html" class="nav-link prev" aria-label="webpack进阶配置"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->webpack进阶配置</div></a><a href="/frontend-service-station/webpack/5-vuecli.html" class="nav-link next" aria-label="VueCli"><div class="hint">下一页<span class="arrow right"></span></div><div class="link">VueCli<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----><!--]--></div><!--]--><!----><!----><!----><!--]--></div>
    <script type="module" src="/frontend-service-station/assets/app.b7c991a3.js" defer></script>
  </body>
</html>
