import{_ as e,C as o,Y as c,Z as i,$ as n,a0 as s,a2 as t,a1 as p}from"./framework-bb209140.js";const l={},u=p(`<h2 id="框架介绍" tabindex="-1"><a class="header-anchor" href="#框架介绍" aria-hidden="true">#</a> 框架介绍</h2><p>midway 是阿里巴巴开源的，基于 TypeScript 语言开发的 Nodejs 后端框架。 本教程指导大家从 0 开始搭建一个 midway 项目。</p><h3 id="编程范式" tabindex="-1"><a class="header-anchor" href="#编程范式" aria-hidden="true">#</a> 编程范式</h3><p><strong>其遵循两种编程范式</strong></p><ul><li>面向对象（OOP + Class + IoC）。</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/controller/home.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Controller<span class="token punctuation">,</span> Get <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ctx<span class="token operator">:</span> Context<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token string">&quot;Hello Midwayjs!&quot;</span><span class="token punctuation">,</span>
      query<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>ip<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>函数式（FP + Function + Hooks）。</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/api/index.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> useContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/hooks&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useContext</span><span class="token generic class-name"><span class="token operator">&lt;</span>Context<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    message<span class="token operator">:</span> <span class="token string">&quot;Hello Midwayjs!&quot;</span><span class="token punctuation">,</span>
    query<span class="token operator">:</span> ctx<span class="token punctuation">.</span>ip<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="谁较容易上手学习" tabindex="-1"><a class="header-anchor" href="#谁较容易上手学习" aria-hidden="true">#</a> 谁较容易上手学习</h3><ul><li>懂 Nodejs 技术的前端开发；</li><li>会 TypeScript 的后端开发；</li></ul><h3 id="可掌握的知识" tabindex="-1"><a class="header-anchor" href="#可掌握的知识" aria-hidden="true">#</a> 可掌握的知识</h3><ul><li>面向对象的开发体验；</li><li>增删改查及基类封装；</li><li>数据库操作；</li><li>缓存操作；</li><li>用户安全认证及访问安全控制；</li><li>JWT 访问凭证；</li><li>分布式访问状态管理；</li><li>密码加解密；</li><li>统一返回结果封装；</li><li>统一异常管理；</li><li>Snowflake 主键生成；</li><li>Swagger 集成及支持访问认证；</li><li>环境变量的使用；</li><li>Docker 镜像构建；</li><li>Serverless 发布；</li></ul>`,12),r={href:"https://github.com/mi-saka10032/jay-music-manage-system",target:"_blank",rel:"noopener noreferrer"},k={href:"https://github.com/bestaone/midway-boot/blob/main/Tutorials.md",target:"_blank",rel:"noopener noreferrer"},d=p(`<h2 id="环境准备" tabindex="-1"><a class="header-anchor" href="#环境准备" aria-hidden="true">#</a> 环境准备</h2><ul><li>Nodejs v16+</li><li>Npm v9+</li><li>Mysql v8+</li><li>Redis v7+</li></ul><p>建议安装 mysql v8.0 以上的版本，Redis 安装启动后维持后台运行即可。</p><p>上面的应用安装步骤略。</p><h2 id="项目初始化" tabindex="-1"><a class="header-anchor" href="#项目初始化" aria-hidden="true">#</a> 项目初始化</h2><h3 id="初始化创建" tabindex="-1"><a class="header-anchor" href="#初始化创建" aria-hidden="true">#</a> 初始化创建</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> init midway
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>执行命令后，需要选择模板，标准项目需要选择：koa-v3；</p><p>项目名可以自定义。</p><h3 id="启动" tabindex="-1"><a class="header-anchor" href="#启动" aria-hidden="true">#</a> 启动</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> run dev
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>启动后浏览器访问：<code>http://127.0.0.1:7001</code></p><h3 id="调整-prettier-配置" tabindex="-1"><a class="header-anchor" href="#调整-prettier-配置" aria-hidden="true">#</a> 调整 prettier 配置</h3><p>为了保证代码风格统一，我们调整下 prettier 配置</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 这是项目模板默认配置</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mwts/.prettierrc.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">endOfLine</span><span class="token operator">:</span> <span class="token string">&quot;lf&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 换行符使用 lf</span>
  <span class="token literal-property property">printWidth</span><span class="token operator">:</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token comment">// 一行最多 120 字符</span>
  <span class="token literal-property property">proseWrap</span><span class="token operator">:</span> <span class="token string">&quot;preserve&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 使用默认的折行标准</span>
  <span class="token literal-property property">semi</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 行尾需要有分号</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>midway 默认使用 mwts 库作为格式化依据，也可以根据自己的其他书写需要自定义覆盖规则</strong></p><p><strong>在 windows 中代码的首行、尾行不能有空行，否则 ESLint 提示格式错误，可能是 bug</strong></p><h2 id="增删改查" tabindex="-1"><a class="header-anchor" href="#增删改查" aria-hidden="true">#</a> 增删改查</h2><p>midway 使用 TypeORM 来实现 Object Relation Mapping，提供数据库操作能力。</p><h3 id="安装依赖" tabindex="-1"><a class="header-anchor" href="#安装依赖" aria-hidden="true">#</a> 安装依赖</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> i @midwayjs/typeorm@3 typeorm <span class="token parameter variable">--save</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>安装完后 package.json 文件中会多出如下配置</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@midwayjs/typeorm&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.4.4&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;typeorm&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.3.7&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="引入组件" tabindex="-1"><a class="header-anchor" href="#引入组件" aria-hidden="true">#</a> 引入组件</h3><p>在 <code>src/configuration.ts</code> 中引入 orm 组件</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// configuration.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Configuration<span class="token punctuation">,</span> App <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> koa <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> validate <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/validate&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> info <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/info&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ReportMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./middleware/report.middleware&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> orm <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/typeorm&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Configuration</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    orm<span class="token punctuation">,</span> <span class="token comment">// 引入orm组件</span>
    koa<span class="token punctuation">,</span>
    validate<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      component<span class="token operator">:</span> info<span class="token punctuation">,</span>
      enabledEnvironment<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;local&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  importConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ContainerLifeCycle</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  app<span class="token operator">:</span> koa<span class="token punctuation">.</span>Application<span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">useMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">[</span>ReportMiddleware<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="添加数据库配置" tabindex="-1"><a class="header-anchor" href="#添加数据库配置" aria-hidden="true">#</a> 添加数据库配置</h3><p>修改配置 <code>src/config/config.default.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/config/config.default.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MidwayConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/core&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  keys<span class="token operator">:</span> <span class="token string">&quot;1657707214114_9253&quot;</span><span class="token punctuation">,</span>
  koa<span class="token operator">:</span> <span class="token punctuation">{</span>
    port<span class="token operator">:</span> <span class="token number">7001</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 添加orm配置</span>
  typeorm<span class="token operator">:</span> <span class="token punctuation">{</span>
    dataSource<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">&quot;mysql&quot;</span><span class="token punctuation">,</span>
        host<span class="token operator">:</span> <span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 改成你的mysql数据库IP</span>
        port<span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span> <span class="token comment">// 改成你的mysql数据库端口</span>
        username<span class="token operator">:</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 改成你的mysql数据库用户名（需要有创建表结构权限）</span>
        password<span class="token operator">:</span> <span class="token string">&quot;123456&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 改成你的mysql数据库密码</span>
        database<span class="token operator">:</span> <span class="token string">&quot;jay_music_manage_system&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 改成你的mysql数据库IP</span>
        synchronize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 如果第一次使用，不存在表，有同步的需求可以写 true</span>
        logging<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        entities<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;**/entity/*{.ts,.js}&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">as</span> MidwayConfig<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意：首次启动没有创建表结构的，需要设置自动创建表接口 synchronize: true。</strong></p><p><strong>synchronize 这个属性需慎用，一旦相关的 Entity 实体类发生变化，都会影响到数据库表结构修改，建议正式环境只启用一次。后续表结构的变更调整建议走 mysql 脚本</strong></p><h3 id="安装-mysql-驱动" tabindex="-1"><a class="header-anchor" href="#安装-mysql-驱动" aria-hidden="true">#</a> 安装 MySql 驱动</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> mysql2 <span class="token parameter variable">--save</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>安装完后 package.json 文件中会多出如下配置</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;mysql2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.3.3&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>orm 的详细文档见：</p>`,36),v={href:"http://www.midwayjs.org/docs/extensions/orm",target:"_blank",rel:"noopener noreferrer"},m=p(`<h3 id="mvc" tabindex="-1"><a class="header-anchor" href="#mvc" aria-hidden="true">#</a> MVC</h3><h4 id="创建-entity-实体类" tabindex="-1"><a class="header-anchor" href="#创建-entity-实体类" aria-hidden="true">#</a> 创建 Entity 实体类</h4><ol><li>创建目录 <code>src/entity</code>;</li><li>在该目录下创建实体类 <code>user.ts</code>;</li></ol><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/entity/user.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Entity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/typeorm&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  CreateDateColumn<span class="token punctuation">,</span>
  PrimaryColumn<span class="token punctuation">,</span>
  UpdateDateColumn<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;bigint&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> nullable<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  avatarUrl<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> unique<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> <span class="token number">200</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  phoneNum<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  regtime<span class="token operator">:</span> Date<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;bigint&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  updaterId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;bigint&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  createrId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">CreateDateColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  createTime<span class="token operator">:</span> Date<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">UpdateDateColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  updateTime<span class="token operator">:</span> Date<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;int&quot;</span><span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  status<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>@EntityModel</code> 用来定义一个实体类；</li><li><code>@Column</code> 用来描述类的一个熟悉，对应数据库就是一个数据列；</li><li><code>@PrimaryColumn</code> 用来定义一个主键，每个实体类必须要要主键；</li><li><code>@PrimaryGeneratedColumn</code> 用来定义一个自增主键；</li><li><code>@CreateDateColumn</code> 定义创建时，自动设置日期；</li><li><code>@UpdateDateColumn</code> 定义更新时，自动设置日期；</li></ul><p>对应的数据库结构</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">\`</span>user<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>avatarUrl<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>username<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>password<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>phoneNum<span class="token punctuation">\`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>regtime<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>updaterId<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>createrId<span class="token punctuation">\`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>createTime<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>updateTime<span class="token punctuation">\`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">\`</span>status<span class="token punctuation">\`</span></span> <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>id<span class="token punctuation">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">\`</span>IDX_78a916df40e02a9deb1c4b75ed<span class="token punctuation">\`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">\`</span>username<span class="token punctuation">\`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="创建-userservice" tabindex="-1"><a class="header-anchor" href="#创建-userservice" aria-hidden="true">#</a> 创建 UserService</h4><p>创建或者修改 <code>src/service/user.service.ts</code> 文件。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/service/user.service.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../eneity/user&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectEntityModel <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/typeorm&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DeleteResult <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm/query-builder/result/DeleteResult&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Provide</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectEntityModel</span></span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  userModel<span class="token operator">:</span> Repository<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>user<span class="token operator">:</span> User<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userModel<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userModel<span class="token punctuation">.</span><span class="token function">findOneBy</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token keyword">delete</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>DeleteResult<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userModel<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>@Provide</code> 表示这个类将会由系统自动实例化，在使用的时候，只需要使用 <code>@Inject</code> 注入就可以了；</li><li><code>@InjectEntityModel</code> 注入实体模型数据库操作工具；</li></ul><p>注意：由于调整了 UserService，<code>src/controller/api.controller.ts</code>、<code>test/controller/api.test.ts</code>会报错，直接删掉即可（这部分是 midway 原始项目模板中的老文件）</p><h4 id="创建-usercontroller" tabindex="-1"><a class="header-anchor" href="#创建-usercontroller" aria-hidden="true">#</a> 创建 UserController</h4><p>创建或者修改 <code>src/controller/user.controller.ts</code> 文件。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/controller/user.controller.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Inject<span class="token punctuation">,</span> Controller<span class="token punctuation">,</span> Query<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Body <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../eneity/user&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../service/user.service&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DeleteResult <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm/query-builder/result/DeleteResult&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">&quot;/api/user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  userService<span class="token operator">:</span> UserService<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/create&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;创建&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token operator">:</span> User<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      regtime<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      updaterId<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      createrId<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/findById&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;通过主键查找&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/delete&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;删除&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>DeleteResult<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>@Inject()</code> 装饰类指定该对象会被自动注入。</p><h3 id="单元测试" tabindex="-1"><a class="header-anchor" href="#单元测试" aria-hidden="true">#</a> 单元测试</h3><h4 id="添加单元测试类" tabindex="-1"><a class="header-anchor" href="#添加单元测试类" aria-hidden="true">#</a> 添加单元测试类</h4><p>添加文件 <code>test/controller/user.test.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// test/controller/user.test.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> close<span class="token punctuation">,</span> createApp<span class="token punctuation">,</span> createHttpRequest <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/mock&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Application<span class="token punctuation">,</span> Framework <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../src/eneity/user&quot;</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;test/controller/user.test.ts&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> app<span class="token operator">:</span> Application<span class="token punctuation">;</span>
  <span class="token keyword">let</span> o<span class="token operator">:</span> User<span class="token punctuation">;</span>

  <span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      app <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token generic-function"><span class="token function">createApp</span><span class="token generic class-name"><span class="token operator">&lt;</span>Framework<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;test beforeAll error&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">close</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// create</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;should POST /api/user/create&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      username<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      phoneNum<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createHttpRequest</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/api/user/create&quot;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将创建好的数据存起来，以供后面测试使用（返回的数据会有id）</span>
    o <span class="token operator">=</span> result<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// findById</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;should POST /api/user/findById&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createHttpRequest</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
      <span class="token string">&quot;/api/user/findById?id=&quot;</span> <span class="token operator">+</span> o<span class="token punctuation">.</span>id
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// delete</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;should POST /api/user/delete&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">createHttpRequest</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
      <span class="token string">&quot;/api/user/delete?id=&quot;</span> <span class="token operator">+</span> o<span class="token punctuation">.</span>id
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>beforeAll、afterAll 分别会在测试开始前、后执行；</li><li><code>createApp&lt;Framework&gt;()</code> BeforeAll 阶段的 error 会忽略，需要手动处理异常；</li></ul><p>单元测试的详细文档，见：</p>`,22),b={href:"http://www.midwayjs.org/docs/testing",target:"_blank",rel:"noopener noreferrer"},y=p(`<h4 id="执行单元测试" tabindex="-1"><a class="header-anchor" href="#执行单元测试" aria-hidden="true">#</a> 执行单元测试</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> run <span class="token builtin class-name">test</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果测试时间过长，会导致测试失败，我们需要修改超时时间</p><h4 id="修改超时时间" tabindex="-1"><a class="header-anchor" href="#修改超时时间" aria-hidden="true">#</a> 修改超时时间</h4><p>在根目录添加文件 <code>jest.setup.js</code>;</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// jest.setup.js</span>
<span class="token comment">// 只需要一行代码</span>
<span class="token comment">// 设置单元测试超时时间</span>
jest<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改 jest 配置文件 <code>jest.config.js</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">preset</span><span class="token operator">:</span> <span class="token string">&quot;ts-jest&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">testEnvironment</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">testPathIgnorePatterns</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&lt;rootDir&gt;/test/fixtures&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">coveragePathIgnorePatterns</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&lt;rootDir&gt;/test/&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 添加如下一行代码，引入jest初始化文件</span>
  <span class="token literal-property property">setupFilesAfterEnv</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&lt;rootDir&gt;/jest.setup.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="封装增删改查" tabindex="-1"><a class="header-anchor" href="#封装增删改查" aria-hidden="true">#</a> 封装增删改查</h2><h3 id="问题" tabindex="-1"><a class="header-anchor" href="#问题" aria-hidden="true">#</a> 问题</h3><ol><li>大多数情况，所有实体类都有统一字段，需要抽取实体模型的基类；</li><li>需要将 Service 的基本操作封装起来；</li><li>需要将 Controller 的基本操作封装起来。</li></ol><h3 id="抽取-entity-基类" tabindex="-1"><a class="header-anchor" href="#抽取-entity-基类" aria-hidden="true">#</a> 抽取 Entity 基类</h3><ol><li>创建目录 <code>common</code>;</li><li>创建基类 <code>src/common/BaseEntity.ts</code>;</li></ol><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/common/BaseEntity.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Column<span class="token punctuation">,</span>
  CreateDateColumn<span class="token punctuation">,</span>
  PrimaryColumn<span class="token punctuation">,</span>
  UpdateDateColumn<span class="token punctuation">,</span>
  ValueTransformer<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ApiProperty <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/swagger&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 用于处理和转换typeORM在返回主键数据时自动将bigint类型转换为string类型，导致前端总是获取string类型而非number类型数据的问题</span>
<span class="token keyword">class</span> <span class="token class-name">BigIntTransformer</span> <span class="token keyword">implements</span> <span class="token class-name">ValueTransformer</span> <span class="token punctuation">{</span>
  <span class="token function">to</span><span class="token punctuation">(</span>value<span class="token operator">:</span> bigint <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">from</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 所有使用Base封装MVC的Entity实体类都需要继承BaseEntity</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;bigint&quot;</span><span class="token punctuation">,</span> transformer<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">BigIntTransformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiProperty</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;更新人ID&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;bigint&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  updaterId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiProperty</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;创建人ID&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;bigint&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  createrId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiProperty</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;创建时间&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">CreateDateColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  createTime<span class="token operator">:</span> Date<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiProperty</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;更新时间&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">UpdateDateColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  updateTime<span class="token operator">:</span> Date<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>调整实体类 <code>src/entity/user.ts</code>，继承 <code>BaseEntity</code>，并删除<code>user.ts</code>中的通用字段。</li><li>增加主键 id 的类型转换。</li></ul><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/entity/user.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Entity<span class="token punctuation">,</span> Column <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BaseEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../common/BaseEntity&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ApiProperty <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/swagger&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 系统用户实体类</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">BaseEntity</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiProperty</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;头像&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> nullable<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  avatarUrl<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiProperty</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;用户名&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> unique<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiProperty</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;密码&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> <span class="token number">200</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiProperty</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;注册时间&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  regTime<span class="token operator">:</span> Date<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiProperty</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;状态 0：不可用，1：正常&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;int&quot;</span><span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  status<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="抽取-service-基类" tabindex="-1"><a class="header-anchor" href="#抽取-service-基类" aria-hidden="true">#</a> 抽取 Service 基类</h3><p>创建基类 <code>src/common/BaseService.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/common/BaseService.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Between<span class="token punctuation">,</span>
  FindOptionsSelect<span class="token punctuation">,</span>
  ILike<span class="token punctuation">,</span>
  In<span class="token punctuation">,</span>
  LessThanOrEqual<span class="token punctuation">,</span>
  MoreThanOrEqual<span class="token punctuation">,</span>
  Repository<span class="token punctuation">,</span>
  SelectQueryBuilder<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Inject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> SnowflakeIdGenerate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils/Snowflake&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BaseEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./BaseEntity&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BaseVO <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../music-api/vo/BaseVO&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Page <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./Page&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FindOptionsWhere <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm/find-options/FindOptionsWhere&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ILogger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defaultPageNo<span class="token punctuation">,</span> defaultPageSize <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../decorator/page.decorator&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">BatchWhereOption</span> <span class="token punctuation">{</span>
  table<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  column<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  value<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  condition<span class="token operator">:</span>
    <span class="token operator">|</span> <span class="token string">&quot;equal&quot;</span>
    <span class="token operator">|</span> <span class="token string">&quot;like&quot;</span>
    <span class="token operator">|</span> <span class="token string">&quot;moreThan&quot;</span>
    <span class="token operator">|</span> <span class="token string">&quot;lessThan&quot;</span>
    <span class="token operator">|</span> <span class="token string">&quot;moreThanOrEqual&quot;</span>
    <span class="token operator">|</span> <span class="token string">&quot;lessThanOrEqual&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * SERVICE的基类
 */</span>
<span class="token keyword">export</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseService<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> BaseEntity<span class="token punctuation">,</span> <span class="token constant">V</span> <span class="token keyword">extends</span> BaseVO<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  idGenerate<span class="token operator">:</span> SnowflakeIdGenerate<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  logger<span class="token operator">:</span> ILogger<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ctx<span class="token operator">:</span> Context<span class="token punctuation">;</span>

  <span class="token comment">// 获取实体库</span>
  <span class="token keyword">abstract</span> <span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Repository<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取VO对象</span>
  <span class="token keyword">abstract</span> <span class="token function">getVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">V</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取VO对象指定查询列字段 不提供Array 默认为where提供undefined全量查询</span>
  <span class="token keyword">abstract</span> <span class="token function">getColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token keyword">keyof</span> <span class="token constant">V</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * @description 字符串全模糊匹配查询 为typeORM的快捷API(find系列)补全where对象
   * @param where typeORM的条件对象
   */</span>
  <span class="token keyword">public</span> <span class="token function">fuzzyWhere</span><span class="token punctuation">(</span>where<span class="token operator">:</span> FindOptionsWhere<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> whereKey <span class="token keyword">in</span> where<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> option <span class="token operator">=</span> where<span class="token punctuation">[</span>whereKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> option <span class="token operator">===</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        where<span class="token punctuation">[</span><span class="token function">String</span><span class="token punctuation">(</span>whereKey<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ILike</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">%</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>option<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @description 日期范围条件匹配查询 为typeORM的快捷API(find系列)补全where对象
   * @param where
   * @param whereKey Entity的键值名
   * @param startDate 起始日期
   * @param endDate 结束日期
   */</span>
  <span class="token keyword">public</span> <span class="token function">dateRangeWhere</span><span class="token punctuation">(</span>
    where<span class="token operator">:</span> FindOptionsWhere<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    whereKey<span class="token operator">:</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token punctuation">,</span>
    startDate<span class="token operator">:</span> Date <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    endDate<span class="token operator">:</span> Date <span class="token operator">|</span> <span class="token keyword">null</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> left<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> startDate <span class="token operator">?</span> <span class="token number">0b0010</span> <span class="token operator">:</span> <span class="token number">0b0000</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> right<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> endDate <span class="token operator">?</span> <span class="token number">0b0001</span> <span class="token operator">:</span> <span class="token number">0b0000</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> range<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> left <span class="token operator">|</span> right<span class="token punctuation">;</span>
    <span class="token comment">// range的结果有4种(3|2|1|0)，分别代表不同的SQL语句</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>range<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        where<span class="token punctuation">[</span><span class="token function">String</span><span class="token punctuation">(</span>whereKey<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Between</span><span class="token punctuation">(</span>startDate<span class="token punctuation">,</span> endDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        where<span class="token punctuation">[</span><span class="token function">String</span><span class="token punctuation">(</span>whereKey<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">MoreThanOrEqual</span><span class="token punctuation">(</span>startDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        where<span class="token punctuation">[</span><span class="token function">String</span><span class="token punctuation">(</span>whereKey<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">LessThanOrEqual</span><span class="token punctuation">(</span>endDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        where<span class="token punctuation">[</span><span class="token function">String</span><span class="token punctuation">(</span>whereKey<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @description createQueryBuilder模式下批量where条件的插值方法 typeORM的createQueryBuilder模式专用
   * @param builder createQueryBuilder返回值
   * @param whereOptions Array&lt;{ table:表名, column:列名, value:列值(可能为空), condition:多条件判断 }&gt;
   */</span>
  <span class="token keyword">public</span> <span class="token function">builderBatchWhere</span><span class="token punctuation">(</span>
    builder<span class="token operator">:</span> SelectQueryBuilder<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    whereOptions<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>BatchWhereOption<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> option <span class="token keyword">of</span> whereOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> table<span class="token punctuation">,</span> column<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> condition <span class="token punctuation">}</span> <span class="token operator">=</span> option<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>condition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">case</span> <span class="token string">&quot;equal&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>table<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>column<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> = :</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">case</span> <span class="token string">&quot;like&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>table<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>column<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> LIKE :</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
              <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">%</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">%</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">case</span> <span class="token string">&quot;lessThan&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>table<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>column<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> &lt; :</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">case</span> <span class="token string">&quot;lessThanOrEqual&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>table<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>column<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> &lt;= :</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">case</span> <span class="token string">&quot;moreThan&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>table<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>column<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> &gt; :</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">case</span> <span class="token string">&quot;moreThanOrEqual&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">andWhere</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>table<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>column<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> &gt;= :</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">:</span> value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @description 新增或更新指定对象数据 private内部使用
   * @param o 待新增or更新的对象 model统一使用save执行
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token function">save</span><span class="token punctuation">(</span>o<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    o<span class="token punctuation">.</span>updaterId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>userContext<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>
    <span class="token keyword">const</span> result<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> resultVO<span class="token operator">:</span> <span class="token constant">V</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>resultVO<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @description 新建数据
   * @param o o.id必须为空
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>o<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    o<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>idGenerate<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    o<span class="token punctuation">.</span>createrId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>userContext<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @description 更新数据
   * @param o o.id不能为空
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span>o<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 根据id删除指定对象</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token keyword">delete</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @description 根据id查询指定对象
   * @param id
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> select <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">unknown</span> <span class="token keyword">as</span> FindOptionsSelect<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> where <span class="token operator">=</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token keyword">as</span> FindOptionsWhere<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> select<span class="token punctuation">,</span> where <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> resultVO<span class="token operator">:</span> <span class="token constant">V</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>resultVO<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @description 根据多个id查询对象列表
   * @param ids
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">findByIds</span><span class="token punctuation">(</span>ids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">V</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 指定VO字段查询列</span>
    <span class="token keyword">const</span> select <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">unknown</span> <span class="token keyword">as</span> FindOptionsSelect<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> where <span class="token operator">=</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token function">In</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token keyword">as</span> FindOptionsWhere<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> list<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> select<span class="token punctuation">,</span> where <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> listVO<span class="token operator">:</span> <span class="token constant">V</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>listVO<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @description 分页模糊查询
   * @param where 筛选条件，string类型默认全模糊(%s%)匹配
   * @param pageNo 去除非空校验，默认取1
   * @param pageSize 去除非空校验，默认取10
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">page</span><span class="token punctuation">(</span>
    where<span class="token operator">:</span> FindOptionsWhere<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">defaultPageNo</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> pageNo<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">defaultPageSize</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> pageSize<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Page<span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> skip <span class="token operator">=</span> <span class="token punctuation">(</span>pageNo <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pageSize<span class="token punctuation">;</span>
    <span class="token keyword">const</span> take <span class="token operator">=</span> pageSize<span class="token punctuation">;</span>
    <span class="token comment">// 字符串模糊匹配</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fuzzyWhere</span><span class="token punctuation">(</span>where<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 指定VO字段查询列</span>
    <span class="token keyword">const</span> select <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">unknown</span> <span class="token keyword">as</span> FindOptionsSelect<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>list<span class="token punctuation">,</span> total<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAndCount</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      select<span class="token punctuation">,</span>
      where<span class="token punctuation">,</span>
      skip<span class="token punctuation">,</span>
      take<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> listVO<span class="token operator">:</span> <span class="token constant">V</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>listVO<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Page<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>listVO<span class="token punctuation">,</span> total<span class="token punctuation">,</span> pageNo<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * @description 根据部分对象内部属性查询指定对象
   * @param where 筛选条件，string类型默认全模糊(%s%)匹配
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>where<span class="token operator">:</span> FindOptionsWhere<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 字符串模糊匹配</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fuzzyWhere</span><span class="token punctuation">(</span>where<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 指定VO字段查询列</span>
    <span class="token keyword">const</span> select <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">unknown</span> <span class="token keyword">as</span> FindOptionsSelect<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> select<span class="token punctuation">,</span> where <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> resultVO<span class="token operator">:</span> <span class="token constant">V</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>resultVO<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>&lt;T extends BaseEntity&gt;</code> 泛型用法，定义 <code>T</code> 为 <code>BaseEntity</code> 的子类</li><li><code>&lt;V extends BaseVO&gt;</code> 泛型用法，定义 <code>V</code> 为 <code>BaseVO</code>的子类，也就是继承了<code>id</code>属性的 VO 类</li><li>基类定义为抽象类 <code>abstract</code>,并添加三个抽象接口 <ol><li><code>abstract getModel()</code>：向其实现类提供外部实体类，用于 ORM 操作</li><li><code>getVO()</code>：实现类提供指定 VO 泛型的返回类实例，返回 VO 对象而不是原生的 Entity 对象</li><li><code>getColumns()</code>：每个实现类都必填的指定列字段数组，目的是执行查询的时候指定字段（如指定 id、username、password）查询返回而不是<code>SELECT *</code>全量返回</li></ol></li><li>提供三个自定义的 ORM 操作方法 <ol><li><code>fuzzyWhere</code>：指定 ORM 查询的对象参数 WhereOption，属性值符合字符串类型的全部转化为全模糊匹配，如：<code>{ username: &#39;三&#39; }</code>,转化后执行 ORM 查询等价于<code>select * from user where username LIKE &#39;%三%&#39;;</code>；</li><li><code>dateRangeWhere</code>：指定 ORM 查询的对象参数 WhereOption，指定属性值 key，为其赋予起始日期或截止日期的查询参数，如：<code>{ startDate: new Date(&#39;2022-1-1&#39;), endDate: new Date(&#39;2023-1-1&#39;) }</code>，指定 key 为<code>publishTime</code>，转化后执行 ORM 查询等价于<code>select * from user where publishTime</code> &gt;= &#39;2022-1-1&#39; and publishTime &lt;= &#39;2023-1-1&#39;;\`；</li><li><code>builderBatchWhere</code>：为 ORM 创建的 queryBuilder 提供批量 where 查询参数的插入，集成了上面两个方法的功能，但是不同的是上面两个方法适用于快捷 ORM 查询（<code>this.model.find({ where })</code>），而这个方法只适用于了通过 model 创建的 queryBuilder。</li></ol></li><li>其他方法都是基于 typeORM 的方法封装，最终返回 VO 类实例。需要注意的是 create 和 update 方法会插入 createrId 和 updaterId，这两者从登录成功后赋予到服务上下文的操作中获取，因此涉及新增和更新操作的要求必须先执行登录操作。</li></ul><p>调整 <code>src/service/user.service.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Inject<span class="token punctuation">,</span> Provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectEntityModel <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/typeorm&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../entity/user&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BaseService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../common/BaseService&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserVO <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../music-api/vo/LoginVO&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Provide</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">extends</span> <span class="token class-name">BaseService<span class="token operator">&lt;</span>User<span class="token punctuation">,</span> UserVO<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectEntityModel</span></span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  model<span class="token operator">:</span> Repository<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Repository<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token keyword">keyof</span> UserVO<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;regTime&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;status&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ctx<span class="token operator">:</span> Context<span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">findByUsername</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token operator">:</span> <span class="token punctuation">{</span> username <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>添加继承 <code>UserService extends BaseService&lt;User&gt;</code></li><li>实现接口 <code>getModel()</code>，并返回 <code>Repository</code></li><li>指定查询列字段数组 <code>getColumns()</code></li><li>实现一个指定 username 查询的方法</li></ul><h3 id="抽取-controller-基类" tabindex="-1"><a class="header-anchor" href="#抽取-controller-基类" aria-hidden="true">#</a> 抽取 Controller 基类</h3><p>创建基类 <code>src/common/BaseController.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/common/BaseController.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BaseService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./BaseService&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BaseEntity <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./BaseEntity&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BaseVO <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../music-api/vo/BaseVO&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Body<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Query <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ApiResponse <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/swagger&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Page <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./Page&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Assert <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./Assert&quot;</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Controller基础类，由于类继承不支持装饰类@Post、@Query、@Body等，
 * 所以这里的装饰类不生效，否则实现类就不需要再写多余代码了，
 * 这里保留在这里，以备以后可能会支持继承的装饰类
 */</span>
<span class="token keyword">export</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseController<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> BaseEntity<span class="token punctuation">,</span> <span class="token constant">V</span> <span class="token keyword">extends</span> BaseVO<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">abstract</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> BaseService<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token punctuation">,</span> <span class="token constant">V</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/create&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> body<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    Assert<span class="token punctuation">.</span><span class="token function">baseAssert_CreateObj</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Assert<span class="token punctuation">.</span><span class="token function">baseAssert_CreateId</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/delete&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    Assert<span class="token punctuation">.</span><span class="token function">baseAssert_DeleteId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/update&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> body<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    Assert<span class="token punctuation">.</span><span class="token function">baseAssert_UpdateObj</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Assert<span class="token punctuation">.</span><span class="token function">baseAssert_UpdateId</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/findById&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    Assert<span class="token punctuation">.</span><span class="token function">baseAssert_FindId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiResponse</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;通过一批主键查找&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/findByIds&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findByIds</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">&quot;ids&quot;</span><span class="token punctuation">)</span> ids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">V</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    Assert<span class="token punctuation">.</span><span class="token function">baseAssert_FindIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findByIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiResponse</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;分页查询&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/page&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">page</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> map<span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Page<span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    Assert<span class="token punctuation">.</span><span class="token function">baseAssert_QueryPage</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> pageNo <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;pageNo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> pageSize <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;pageSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;pageNo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;pageSize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> where <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>where<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span>where<span class="token punctuation">,</span> pageNo<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/findOne&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> body<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token constant">V</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    Assert<span class="token punctuation">.</span><span class="token function">baseAssert_QueryOne</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> where <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      where<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> body<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>where<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>基类定义为抽象类 <code>abstract</code>,并添加抽象接口 <code>abstract getService()</code></li><li><code>&lt;T extends BaseEntity&gt;</code> 泛型用法，定义 <code>T</code> 为 <code>BaseEntity</code> 的子类</li><li><code>&lt;V extends BaseVO&gt;</code> 泛型用法，定义 <code>V</code>为<code>BaseVO</code>的子类，同时也是各方法的返回值</li></ul><p>调整 <code>src/controller/user.controller.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/controller/user.controller.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Body<span class="token punctuation">,</span> Controller<span class="token punctuation">,</span> Inject<span class="token punctuation">,</span> Post<span class="token punctuation">,</span> Query <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../service/user.service&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../entity/user&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BaseController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../common/BaseController&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BaseService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../common/BaseService&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RedisService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/redis&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ApiBearerAuth<span class="token punctuation">,</span> ApiResponse<span class="token punctuation">,</span> ApiTags <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/swagger&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> encrypt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils/PasswordEncoder&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Assert <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../common/Assert&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ErrorCode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../music-api/code/ErrorCode&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Page <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../common/Page&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserVO <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../music-api/vo/LoginVO&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiTags</span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiBearerAuth</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">&quot;/api/user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController<span class="token operator">&lt;</span>User<span class="token punctuation">,</span> UserVO<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ctx<span class="token operator">:</span> Context<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  userService<span class="token operator">:</span> UserService<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  cacheUtil<span class="token operator">:</span> RedisService<span class="token punctuation">;</span>

  <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> BaseService<span class="token operator">&lt;</span>User<span class="token punctuation">,</span> UserVO<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiResponse</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> UserVO <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/create&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;创建&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token operator">:</span> User<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>UserVO<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>username<span class="token punctuation">,</span> ErrorCode<span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;username不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>password<span class="token punctuation">,</span> ErrorCode<span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;password不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      regTime<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> newUser <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>newUser<span class="token punctuation">,</span> <span class="token punctuation">{</span> password<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/delete&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;删除&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiResponse</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> UserVO <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/update&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;更新&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token operator">:</span> User<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>UserVO<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiResponse</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> UserVO <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/findById&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;通过主键查找&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>UserVO<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiResponse</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> UserVO <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/findByIds&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;通过一批主键查找&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">findByIds</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token string">&quot;ids&quot;</span><span class="token punctuation">)</span> ids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>UserVO<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findByIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiResponse</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> UserVO <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/page&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;分页查询&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">page</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> map<span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Page<span class="token operator">&lt;</span>UserVO<span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">page</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>添加继承 <code>UserController extends BaseController</code></li><li>实现抽象接口 <code>getService()</code></li><li>调用基类方法，使用 <code>super.xxx()</code></li></ul><h3 id="运行单元测试" tabindex="-1"><a class="header-anchor" href="#运行单元测试" aria-hidden="true">#</a> 运行单元测试</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token operator">&gt;</span>npm run <span class="token builtin class-name">test</span>

Test Suites: <span class="token number">2</span> passed, <span class="token number">2</span> total
Tests:       <span class="token number">4</span> passed, <span class="token number">4</span> total
Snapshots:   <span class="token number">0</span> total
Time:        <span class="token number">10.686</span> s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="统一返回结果处理" tabindex="-1"><a class="header-anchor" href="#统一返回结果处理" aria-hidden="true">#</a> 统一返回结果处理</h2><h3 id="middleware" tabindex="-1"><a class="header-anchor" href="#middleware" aria-hidden="true">#</a> Middleware</h3><p>midway 提供了 web 中间件，是在控制器调用之前和之后都能触发调用的函数方法，我们可以利用中间件在接口执行前或执行后，加一些逻辑，比如：统一返回格式（执行后）、接口鉴权（执行前）。</p><h3 id="统一接口状态、异常码" tabindex="-1"><a class="header-anchor" href="#统一接口状态、异常码" aria-hidden="true">#</a> 统一接口状态、异常码</h3><p>添加 <code>src/music-api/code/ErrorCode.ts</code>。错误码可以自行定义</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/music-api/code/ErrorCode.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ErrorCode</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token constant">OK</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 4000 未知异常
   */</span>
  <span class="token keyword">static</span> <span class="token constant">UN_ERROR</span> <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 5000 平台异常
   */</span>
  <span class="token keyword">static</span> <span class="token constant">SYS_ERROR</span> <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 6000 基本的业务异常
   */</span>
  <span class="token keyword">static</span> <span class="token constant">BIZ_ERROR</span> <span class="token operator">=</span> <span class="token number">6000</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 8000 TOKEN异常
   */</span>
  <span class="token keyword">static</span> <span class="token constant">LOGIN_ERROR</span> <span class="token operator">=</span> <span class="token number">8000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>添加通用异常类 <code>src/common/CommonException.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/common/CommonException.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> MidwayError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/core&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CommonException</span> <span class="token keyword">extends</span> <span class="token class-name">MidwayError</span> <span class="token punctuation">{</span>
  code<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  msg<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  data<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>code<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> code<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>msg <span class="token operator">=</span> msg<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="处理出参数据格式" tabindex="-1"><a class="header-anchor" href="#处理出参数据格式" aria-hidden="true">#</a> 处理出参数据格式</h3><p>添加中间件 <code>src/middleware/format.middleware.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/middleware/format.middleware.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Middleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NextFunction<span class="token punctuation">,</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ErrorCode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../common/ErrorCode&quot;</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 对接口返回的数据统一包装
 */</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Middleware</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">FormatMiddleware</span> <span class="token keyword">implements</span> <span class="token class-name">IMiddleware<span class="token operator">&lt;</span>Context<span class="token punctuation">,</span> NextFunction<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token operator">:</span> Context<span class="token punctuation">,</span> next<span class="token operator">:</span> NextFunction<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> code<span class="token operator">:</span> ErrorCode<span class="token punctuation">.</span><span class="token constant">OK</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">,</span> data<span class="token operator">:</span> result <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">match</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;/api&quot;</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;API_RESPONSE_FORMAT&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>@Middleware()</code> 标识此类是一个中间件</li><li><code>match(ctx)</code> 方法确定哪些路径会被拦截</li></ul><p>详细的中间件使用说明见：</p>`,45),w={href:"http://www.midwayjs.org/docs/middleware",target:"_blank",rel:"noopener noreferrer"},g=p(`<p>注册中间件，修改配置文件 <code>src/configuration.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Configuration<span class="token punctuation">,</span> App <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> koa <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> validate <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/validate&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> info <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/info&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ReportMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./middleware/report.middleware&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> orm <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/typeorm&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormatMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./middleware/format.middleware&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Configuration</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    orm<span class="token punctuation">,</span> <span class="token comment">// 引入orm组件</span>
    koa<span class="token punctuation">,</span>
    validate<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      component<span class="token operator">:</span> info<span class="token punctuation">,</span>
      enabledEnvironment<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;local&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  importConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ContainerLifeCycle</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  app<span class="token operator">:</span> koa<span class="token punctuation">.</span>Application<span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注册中间件 FormatMiddleware</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">useMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FormatMiddleware<span class="token punctuation">,</span> ReportMiddleware<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="异常处理" tabindex="-1"><a class="header-anchor" href="#异常处理" aria-hidden="true">#</a> 异常处理</h3><p>midway 提供全局的异常捕获与自动处理，因此统一的异常处理可以使用异常过滤器，可以在这里进行异常的封装处理</p><p>创建或者修改异常过滤器 <code>src/filter/default.filter.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/filter/default.filter.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Catch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ErrorCode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../common/ErrorCode&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Catch</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DefaultErrorFilter</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">catch</span><span class="token punctuation">(</span>err<span class="token operator">:</span> Error<span class="token punctuation">,</span> ctx<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> code<span class="token operator">:</span> ErrorCode<span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">,</span> msg<span class="token operator">:</span> err<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建或者修改异常过滤器 <code>src/filter/notfound.filter.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/filter/notfound.filter.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Catch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> httpError<span class="token punctuation">,</span> MidwayHttpError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Catch</span></span><span class="token punctuation">(</span>httpError<span class="token punctuation">.</span>NotFoundError<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">NotFoundFilter</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">catch</span><span class="token punctuation">(</span>err<span class="token operator">:</span> MidwayHttpError<span class="token punctuation">,</span> ctx<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 404 错误会到这里 也可以参考上面default的写法，返回404的错误信息</span>
    ctx<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/404.html&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注册异常过滤器：</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/configuration.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Configuration<span class="token punctuation">,</span> App <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> koa <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> validate <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/validate&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> info <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/info&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ReportMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./middleware/report.middleware&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> orm <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/typeorm&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> FormatMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./middleware/format.middleware&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NotFoundFilter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./filter/notfound.filter&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DefaultErrorFilter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./filter/default.filter&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Configuration</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    orm<span class="token punctuation">,</span> <span class="token comment">// 引入orm组件</span>
    koa<span class="token punctuation">,</span>
    validate<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      component<span class="token operator">:</span> info<span class="token punctuation">,</span>
      enabledEnvironment<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;local&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  importConfigs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./config&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ContainerLifeCycle</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  app<span class="token operator">:</span> koa<span class="token punctuation">.</span>Application<span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">onReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">useMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FormatMiddleware<span class="token punctuation">,</span> ReportMiddleware<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册异常过滤器</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">useFilter</span><span class="token punctuation">(</span><span class="token punctuation">[</span>NotFoundFilter<span class="token punctuation">,</span> DefaultErrorFilter<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="单元测试-1" tabindex="-1"><a class="header-anchor" href="#单元测试-1" aria-hidden="true">#</a> 单元测试</h3><p>由于调整了返回值，此时单元测试会报错，我们需要调整下单元。修改 <code>test/controller/user.test.ts</code></p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>o <span class="token operator">=</span> result<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
# 改为
o <span class="token operator">=</span> result<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同时由于在<code>baseService</code>中对 create 和 update 操作增加了 userContext.userId 硬性需求，因此单元测试操作前必须执行登录操作注入登录信息到上下文。对此执行 controller 的生命周期封装，service 的单元测试生命周期同理。</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Application<span class="token punctuation">,</span> Framework <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> close<span class="token punctuation">,</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/mock&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../src/service/user.service&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../src/entity/user&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> SnowflakeIdGenerate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../src/utils/Snowflake&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> encrypt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../src/utils/PasswordEncoder&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CommonController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../src/controller/common.controller&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ControllerContext</span> <span class="token punctuation">{</span>
  app<span class="token operator">:</span> Application <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  token<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> globalUsername<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description 单元测试预处理函数-预登录与token注入-Controller专属
 * @param context 注意app与token必须以对象形式传入，个人试验如果以(app, token)单个参数传入，会构成无效拷贝，test.ts函数内部变量无法生效
 */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">beforeHandler</span><span class="token punctuation">(</span>context<span class="token operator">:</span> ControllerContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SnowflakeIdGenerate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> username <span class="token operator">=</span> id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> password <span class="token operator">=</span> id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    globalUsername <span class="token operator">=</span> username<span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token generic-function"><span class="token function">createApp</span><span class="token generic class-name"><span class="token operator">&lt;</span>Framework<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化一个账号</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> context<span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">createAnonymousContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>userContext <span class="token operator">=</span> <span class="token punctuation">{</span> userId<span class="token operator">:</span> id<span class="token punctuation">,</span> username<span class="token operator">:</span> username <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> userService <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>requestContext<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span>UserService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> user<span class="token operator">:</span> User <span class="token operator">=</span> <span class="token keyword">await</span> userService<span class="token punctuation">.</span><span class="token function">findByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      user <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        username<span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">,</span>
        updaterId<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        createrId<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        regTime<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> o <span class="token operator">=</span> <span class="token keyword">await</span> userService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> commonController <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>requestContext<span class="token punctuation">.</span><span class="token function">getAsync</span><span class="token punctuation">(</span>
      CommonController
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取验证码 不直接调用接口因为获取不了图片真正text 从源码可知 验证码id是 \${idPrefix}:\${id}的格式 这里手动获取captchaCode</span>
    <span class="token keyword">const</span> imageResult <span class="token operator">=</span> <span class="token keyword">await</span> commonController<span class="token punctuation">.</span>captchaService<span class="token punctuation">.</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> captchaPrefixId<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span>
      commonController<span class="token punctuation">.</span>captchaService<span class="token punctuation">.</span>captcha<span class="token punctuation">.</span>idPrefix<span class="token punctuation">;</span>
    <span class="token keyword">const</span> captchaId<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> imageResult<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> captchaCode<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span>
      <span class="token keyword">await</span> commonController<span class="token punctuation">.</span>captchaService<span class="token punctuation">.</span>cacheManager<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>captchaPrefixId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>captchaId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> loginVO <span class="token operator">=</span> <span class="token keyword">await</span> commonController<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      username<span class="token punctuation">,</span>
      password<span class="token punctuation">,</span>
      captchaId<span class="token punctuation">,</span>
      captchaCode<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取一个访问凭证</span>
    context<span class="token punctuation">.</span>token <span class="token operator">=</span> loginVO<span class="token punctuation">.</span>accessToken<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;test beforeAll error&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * @description 单元测试后置处理函数-关闭应用-Controller专属
 * @param context 注意app必须以对象形式传入，个人试验如果以(app)单个参数传入，会构成无效拷贝，test.ts函数内部变量无法生效
 */</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">afterHandler</span><span class="token punctuation">(</span>context<span class="token operator">:</span> ControllerContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 删除beforeHandler阶段新增的账号</span>
  <span class="token keyword">const</span> userService <span class="token operator">=</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span>app
    <span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-function"><span class="token function">getAsync</span><span class="token generic class-name"><span class="token operator">&lt;</span>UserService<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>UserService<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> user<span class="token operator">:</span> User <span class="token operator">=</span> <span class="token keyword">await</span> userService<span class="token punctuation">.</span><span class="token function">findByUsername</span><span class="token punctuation">(</span>globalUsername<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> userService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">await</span> <span class="token function">close</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token operator">&gt;</span>npm run <span class="token builtin class-name">test</span>

Test Suites: <span class="token number">2</span> passed, <span class="token number">2</span> total
Tests:       <span class="token number">4</span> passed, <span class="token number">4</span> total
Snapshots:   <span class="token number">0</span> total
Time:        <span class="token number">6.525</span> s, estimated <span class="token number">9</span> s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="工具类" tabindex="-1"><a class="header-anchor" href="#工具类" aria-hidden="true">#</a> 工具类</h2><h3 id="问题-需求" tabindex="-1"><a class="header-anchor" href="#问题-需求" aria-hidden="true">#</a> 问题&amp;需求</h3><ul><li>数据库主键需要是一个有序的、全局唯一的长整形；</li><li>用户的密码需要加密存储，能够验证密码；</li><li>业务异常需要需要返回给前端，这里使用断言工具；</li></ul><h3 id="主键生成器" tabindex="-1"><a class="header-anchor" href="#主键生成器" aria-hidden="true">#</a> 主键生成器</h3><p>Snowflake 主键生成算法是一种分布式唯一 ID 生成算法，它可以在分布式系统中生成唯一的 ID。Snowflake 算法的核心思想是将一个 64 位的二进制整数分成多个部分，每个部分代表不同的信息，从而生成唯一的 ID。</p><p>具体来说，Snowflake 算法将 64 位的二进制整数分成以下几个部分：</p><ol><li>时间戳部分：占用 42 位，精确到毫秒级别，可以使用 69 年。</li><li>数据中心部分：占用 5 位，可以表示 32 个不同的数据中心。</li><li>机器标识部分：占用 5 位，可以表示 32 个不同的机器。</li><li>序列号部分：占用 12 位，可以表示 4096 个不同的序列号。</li></ol><p>Snowflake 算法根据当前时间戳、数据中心、机器标识和序列号生成唯一的 ID。由于时间戳部分在高位，数据中心、机器标识和序列号在低位，因此 Snowflake 算法生成的 ID 是递增的，可以保证在分布式系统中生成的 ID 是唯一的。</p><p>Snowflake 算法的优点是生成的 ID 具有时间戳信息，可以根据 ID 反推出生成时间，同时具有足够的容量和性能。缺点是需要保证数据中心和机器标识的唯一性，同时需要保证系统时钟的同步性。</p><p>对于个人使用的单台云服务器而言，该算法仍然可以放心使用。</p><p>创建工具目录 <code>utils</code></p><p>创建工具类 <code>src/utils/Snowflake.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/utils/Snowflake.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Snowflake主键生成算法
 * 完整的算法是生成的ID长度为20位
 * 但是由于js最大值9007199254740991，再多就会溢出，再多要特殊处理。
 * 所以这里设置长度为16位id。将数据中心位调小到1位，将服务器位调小到1位，将序列位调小到10位
 * 这意味着最多支持两个数据中心，每个数据中心最多支持两台服务器
 */</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Provide</span></span><span class="token punctuation">(</span><span class="token string">&quot;idGenerate&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SnowflakeIdGenerate</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> twepoch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> workerIdBits <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> dataCenterIdBits <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> maxWrokerId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>workerIdBits<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 值为：1</span>
  <span class="token keyword">private</span> maxDataCenterId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataCenterIdBits<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 值为：1</span>
  <span class="token keyword">private</span> sequenceBits <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> workerIdShift <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sequenceBits<span class="token punctuation">;</span> <span class="token comment">// 值为：10</span>
  <span class="token keyword">private</span> dataCenterIdShift <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sequenceBits <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>workerIdBits<span class="token punctuation">;</span> <span class="token comment">// 值为：11</span>
  <span class="token comment">// private timestampLeftShift =</span>
  <span class="token comment">//   this.sequenceBits + this.workerIdBits + this.dataCenterIdBits; // 值为：12</span>
  <span class="token keyword">private</span> sequenceMask <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sequenceBits<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 值为：4095</span>
  <span class="token keyword">private</span> lastTimestamp <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> workerId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//设置默认值,从环境变量取</span>
  <span class="token keyword">private</span> dataCenterId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> sequence <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>_workerId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> _dataCenterId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> _sequence <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>workerId <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxWrokerId <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>workerId <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">&quot;config.worker_id must max than 0 and small than maxWrokerId-[&quot;</span> <span class="token operator">+</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>maxWrokerId <span class="token operator">+</span>
          <span class="token string">&quot;]&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dataCenterId <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxDataCenterId <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataCenterId <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">&quot;config.data_center_id must max than 0 and small than maxDataCenterId-[&quot;</span> <span class="token operator">+</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>maxDataCenterId <span class="token operator">+</span>
          <span class="token string">&quot;]&quot;</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>workerId <span class="token operator">=</span> _workerId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dataCenterId <span class="token operator">=</span> _dataCenterId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sequence <span class="token operator">=</span> _sequence<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> timeGen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> tilNextMillis <span class="token operator">=</span> <span class="token punctuation">(</span>lastTimestamp<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> timestamp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;=</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      timestamp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> timestamp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> nextId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> timestamp<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
        <span class="token string">&quot;Clock moved backwards. Refusing to generate id for &quot;</span> <span class="token operator">+</span>
          <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastTimestamp <span class="token operator">-</span> timestamp<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastTimestamp <span class="token operator">===</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sequence <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sequence <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sequenceMask<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sequence <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timestamp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tilNextMillis</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sequence <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lastTimestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
    <span class="token comment">// js 最大值 9007199254740991，再多就会溢出</span>
    <span class="token comment">// 超过 32 位长度，做位运算会溢出，变成负数，所以这里直接做乘法，乘法会扩大存储</span>
    <span class="token keyword">const</span> timestampPos <span class="token operator">=</span> <span class="token punctuation">(</span>timestamp <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>twepoch<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4096</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> dataCenterPos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataCenterId <span class="token operator">&lt;&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataCenterIdShift<span class="token punctuation">;</span>
    <span class="token keyword">const</span> workerPos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>workerId <span class="token operator">&lt;&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>workerIdShift<span class="token punctuation">;</span>
    <span class="token keyword">return</span> timestampPos <span class="token operator">+</span> dataCenterPos <span class="token operator">+</span> workerPos <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sequence<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  generate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="密码工具" tabindex="-1"><a class="header-anchor" href="#密码工具" aria-hidden="true">#</a> 密码工具</h3><p>安装组件</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> i bcryptjs <span class="token parameter variable">--save</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>添加工具类 <code>src/utils/PasswordEncoder.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/utils/PasswordEncoder.ts</span>
<span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;bcryptjs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 加密。加上前缀{bcrypt}，为了兼容多种加密算法，这里暂时只实现bcrypt算法
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> salt <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">genSaltSync</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> hash <span class="token operator">=</span> bcrypt<span class="token punctuation">.</span><span class="token function">hashSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">&quot;{bcrypt}&quot;</span> <span class="token operator">+</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 解密
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hash<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;{bcrypt}&quot;</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hash <span class="token operator">=</span> hash<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> bcrypt<span class="token punctuation">.</span><span class="token function">compareSync</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="断言工具" tabindex="-1"><a class="header-anchor" href="#断言工具" aria-hidden="true">#</a> 断言工具</h3><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/common/Assert.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CommonException <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./CommonException&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Assert</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * 不为空断言
   */</span>
  <span class="token keyword">static</span> <span class="token function">notNull</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> errorCode<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> errorMsg<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CommonException</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">,</span> errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 空字符串断言
   */</span>
  <span class="token keyword">static</span> <span class="token function">notEmpty</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> errorCode<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> errorMsg<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj <span class="token operator">||</span> <span class="token string">&quot;&quot;</span> <span class="token operator">===</span> obj<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CommonException</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">,</span> errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 布尔断言
   */</span>
  <span class="token keyword">static</span> <span class="token function">isTrue</span><span class="token punctuation">(</span>expression<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span> errorCode<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> errorMsg<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>expression<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CommonException</span><span class="token punctuation">(</span>errorCode<span class="token punctuation">,</span> errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="接口安全认证" tabindex="-1"><a class="header-anchor" href="#接口安全认证" aria-hidden="true">#</a> 接口安全认证</h2><p>很多时候，后端接口需要登录后才能进行访问，甚至有的接口需要拥有相应的权限才能访问。这里实现 bearer 验证方式（bearerFormat 为 JWT）。</p><h3 id="安装-jwt-组件" tabindex="-1"><a class="header-anchor" href="#安装-jwt-组件" aria-hidden="true">#</a> 安装 JWT 组件</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> i @midwayjs/jwt@3 <span class="token parameter variable">--save</span>
<span class="token function">npm</span> i @types/jsonwebtoken --save-dev
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>安装完成后 package.json 文件中会多出如下配置</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@midwayjs/jwt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.3.11&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@types/jsonwebtoken&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^8.5.8&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="添加-jwt-配置" tabindex="-1"><a class="header-anchor" href="#添加-jwt-配置" aria-hidden="true">#</a> 添加 JWT 配置</h3><p>修改 <code>src/config/config.default.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/config/config.default.ts</span>
jwt<span class="token operator">:</span> <span class="token punctuation">{</span>
  secret<span class="token operator">:</span> <span class="token string">&#39;setscrew&#39;</span><span class="token punctuation">,</span>
  expiresIn<span class="token operator">:</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注册 JWT 组件</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/configuration.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> jwt <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/jwt&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Configuration</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    jwt<span class="token punctuation">,</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ContainerLifeCycle</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关于 JWT 的详细使用文档，见：</p>`,48),f={href:"http://www.midwayjs.org/docs/extensions/jwt",target:"_blank",rel:"noopener noreferrer"},h=p(`<h3 id="安装-redis-组件" tabindex="-1"><a class="header-anchor" href="#安装-redis-组件" aria-hidden="true">#</a> 安装 Redis 组件</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> i @midwayjs/redis@3 <span class="token parameter variable">--save</span>
<span class="token function">npm</span> i @types/ioredis --save-dev
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>安装完后 package.json 文件中会多出如下配置</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@midwayjs/redis&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.0.0&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@types/ioredis&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.28.7&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="注册-redis-组件" tabindex="-1"><a class="header-anchor" href="#注册-redis-组件" aria-hidden="true">#</a> 注册 Redis 组件</h3><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/configuration.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> redis <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/redis&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Configuration</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    redis<span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ContainerLifeCycle</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="添加配置" tabindex="-1"><a class="header-anchor" href="#添加配置" aria-hidden="true">#</a> 添加配置</h3><p>修改 <code>src/config/config.default.ts</code></p><h4 id="添加-redis-配置" tabindex="-1"><a class="header-anchor" href="#添加-redis-配置" aria-hidden="true">#</a> 添加 Redis 配置</h4><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/config/config.default.ts</span>
redis<span class="token operator">:</span> <span class="token punctuation">{</span>
  client<span class="token operator">:</span> <span class="token punctuation">{</span>
    host<span class="token operator">:</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">6379</span><span class="token punctuation">,</span>
    db<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>关于 Redis 的详细使用文档，见：</p>`,11),q={href:"http://www.midwayjs.org/docs/extensions/redis",target:"_blank",rel:"noopener noreferrer"},x=p(`<h4 id="添加安全拦截配置" tabindex="-1"><a class="header-anchor" href="#添加安全拦截配置" aria-hidden="true">#</a> 添加安全拦截配置</h4><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/config/config.default.ts</span>
app<span class="token operator">:</span> <span class="token punctuation">{</span>
  security<span class="token operator">:</span> <span class="token punctuation">{</span>
    prefix<span class="token operator">:</span> <span class="token string">&#39;/api&#39;</span><span class="token punctuation">,</span>         <span class="token comment">// 指定已/api开头的接口地址需要拦截</span>
    ignore<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;/api/login&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 指定该接口地址，不需要拦截</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="添加接口安全拦截中间件" tabindex="-1"><a class="header-anchor" href="#添加接口安全拦截中间件" aria-hidden="true">#</a> 添加接口安全拦截中间件</h3><h4 id="添加常量定义" tabindex="-1"><a class="header-anchor" href="#添加常量定义" aria-hidden="true">#</a> 添加常量定义</h4><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/common/Constant.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Constant</span> <span class="token punctuation">{</span>
  <span class="token comment">// 登录验证时，缓存用户登录状态KEY的前缀</span>
  <span class="token keyword">static</span> <span class="token constant">TOKEN</span> <span class="token operator">=</span> <span class="token string">&quot;TOKEN&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="添加用户访问上下文类" tabindex="-1"><a class="header-anchor" href="#添加用户访问上下文类" aria-hidden="true">#</a> 添加用户访问上下文类</h4><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/common/UserContext.ts</span>
<span class="token comment">/**
 * 登录后存储访问上下文的状态数据，同时也会存在redis缓存中
 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserContext</span> <span class="token punctuation">{</span>
  userId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  phoneNum<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>userId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> phoneNum<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>userId <span class="token operator">=</span> userId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>phoneNum <span class="token operator">=</span> phoneNum<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>新增或者编辑 <code>src/interface.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/interface.ts</span>
<span class="token keyword">import</span> <span class="token string">&quot;@midwayjs/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./common/UserContext&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">&quot;@midwayjs/core&quot;</span> <span class="token punctuation">{</span>
  <span class="token keyword">interface</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>
    userContext<span class="token operator">:</span> UserContext<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>新增中间件 <code>src/middleware/security.middleware.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/middleware/security.middleware.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Config<span class="token punctuation">,</span> Inject<span class="token punctuation">,</span> Middleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Context<span class="token punctuation">,</span> NextFunction <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> httpError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/jwt&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../common/UserContext&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RedisService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/redis&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Constant <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../common/Constant&quot;</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 安全验证
 */</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Middleware</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">SecurityMiddleware</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  jwtUtil<span class="token operator">:</span> JwtService<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  cacheUtil<span class="token operator">:</span> RedisService<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Config</span></span><span class="token punctuation">(</span><span class="token string">&quot;app.security&quot;</span><span class="token punctuation">)</span>
  securityConfig<span class="token punctuation">;</span>

  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token operator">:</span> Context<span class="token punctuation">,</span> next<span class="token operator">:</span> NextFunction<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">httpError</span><span class="token punctuation">.</span><span class="token function">UnauthorizedError</span><span class="token punctuation">(</span><span class="token string">&quot;缺少凭证&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> parts <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;authorization&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parts<span class="token punctuation">.</span>length <span class="token operator">!==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">httpError</span><span class="token punctuation">.</span><span class="token function">UnauthorizedError</span><span class="token punctuation">(</span><span class="token string">&quot;无效的凭证&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>scheme<span class="token punctuation">,</span> token<span class="token punctuation">]</span> <span class="token operator">=</span> parts<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^Bearer$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>scheme<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">httpError</span><span class="token punctuation">.</span><span class="token function">UnauthorizedError</span><span class="token punctuation">(</span><span class="token string">&quot;缺少Bearer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 验证token，过期会抛出异常</span>
      <span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtUtil<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token punctuation">{</span> complete<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// jwt中存储的user信息</span>
      <span class="token keyword">const</span> payload <span class="token operator">=</span> jwt<span class="token punctuation">[</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> Constant<span class="token punctuation">.</span><span class="token constant">TOKEN</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> payload<span class="token punctuation">.</span>userId <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> token<span class="token punctuation">;</span>
      <span class="token keyword">const</span> ucStr <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheUtil<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 服务器端缓存中存储的user信息</span>
      <span class="token keyword">const</span> uc<span class="token operator">:</span> UserContext <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>ucStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>username <span class="token operator">!==</span> uc<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">httpError</span><span class="token punctuation">.</span><span class="token function">UnauthorizedError</span><span class="token punctuation">(</span><span class="token string">&quot;无效的凭证&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 存储到访问上下文中</span>
      ctx<span class="token punctuation">.</span>userContext <span class="token operator">=</span> uc<span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token function">match</span><span class="token punctuation">(</span>ctx<span class="token operator">:</span> Context<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> prefix<span class="token punctuation">,</span> ignore <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>securityConfig<span class="token punctuation">;</span>
    <span class="token keyword">const</span> exist <span class="token operator">=</span> ignore<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> item<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>exist<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;SECURITY&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>@Config(&#39;app.security&#39;)</code> 装饰类，指定加载配置文件 <code>src/config/config.**.ts</code> 中对应的配置信息</li><li>使用 JwtService 进行 JWT 编码校验</li></ul><p>jwt token 将用户信息编码在 token 中，解码后可以获取对应用户数据，通常情况下，不需要存储到 redis 中； 但是有个缺点就是，不能人为控制分发出去的 token 失效。所以，有时人们会使用缓存中的用户信息；这里使用了 JWT+Redis 的方式，是为了演示两种做法</p><h4 id="注册使用-jwt-中间件" tabindex="-1"><a class="header-anchor" href="#注册使用-jwt-中间件" aria-hidden="true">#</a> 注册使用 jwt 中间件</h4><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/configuration.ts</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span><span class="token function">useMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  SecurityMiddleware<span class="token punctuation">,</span>
  FormatMiddleware<span class="token punctuation">,</span>
  ReportMiddleware<span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>添加登录接口</p><p>添加 DTO</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/api/dto/CommonDTO.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LoginDTO</span> <span class="token punctuation">{</span>
  username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>添加 VO</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/api/vo/CommonVO.ts</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">LoginVO</span> <span class="token punctuation">{</span>
  accessToken<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  expiresIn<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改 <code>src/service/user.service.ts</code>，添加通过用户名查找用户接口</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../eneity/user&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> InjectEntityModel <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/typeorm&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Repository <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;typeorm&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BaseService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../common/BaseService&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Provide</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">extends</span> <span class="token class-name">BaseService<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectEntityModel</span></span><span class="token punctuation">(</span>User<span class="token punctuation">)</span>
  model<span class="token operator">:</span> Repository<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span><span class="token punctuation">;</span>

  <span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Repository<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findByUsername</span><span class="token punctuation">(</span>username<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> where<span class="token operator">:</span> <span class="token punctuation">{</span> username <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>添加 Controller <code>src/controller/common.controller.ts</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/controller/common.controller.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  Body<span class="token punctuation">,</span>
  Config<span class="token punctuation">,</span>
  Controller<span class="token punctuation">,</span>
  Get<span class="token punctuation">,</span>
  Inject<span class="token punctuation">,</span>
  Post<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/decorator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../service/user.service&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RedisService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/redis&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> LoginDTO <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../music-api/dto/LoginDTO&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Captcha<span class="token punctuation">,</span> LoginVO <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../music-api/vo/LoginVO&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> SnowflakeIdGenerate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils/Snowflake&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JwtService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/jwt&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Assert <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../common/Assert&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ErrorCode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../music-api/code/ErrorCode&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserContext <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../common/UserContext&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Constant <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../common/Constant&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ILogger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/core&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> decrypt <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils/PasswordEncoder&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Validate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/validate&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ApiResponse<span class="token punctuation">,</span> ApiTags <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/swagger&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CaptchaService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/captcha&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiTags</span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;common&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">&quot;/api&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CommonController</span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  logger<span class="token operator">:</span> ILogger<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ctx<span class="token operator">:</span> Context<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  userService<span class="token operator">:</span> UserService<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  cacheUtil<span class="token operator">:</span> RedisService<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  jwtUtil<span class="token operator">:</span> JwtService<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  idGenerate<span class="token operator">:</span> SnowflakeIdGenerate<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Config</span></span><span class="token punctuation">(</span><span class="token string">&quot;jwt&quot;</span><span class="token punctuation">)</span>
  jwtConfig<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  captchaService<span class="token operator">:</span> CaptchaService<span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiResponse</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> LoginVO <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Validate</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;公共网关登录&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> body<span class="token operator">:</span> LoginDTO<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>LoginVO<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 验证码优先校验</span>
    <span class="token keyword">const</span> passed<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>captchaService<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>
      body<span class="token punctuation">.</span>captchaId<span class="token punctuation">,</span>
      body<span class="token punctuation">.</span>captchaCode
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    Assert<span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>passed<span class="token punctuation">,</span> ErrorCode<span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;验证码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">findByUsername</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 登录空判</span>
    Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> ErrorCode<span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;用户不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> flag<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">=</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 密码校验</span>
    Assert<span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>flag<span class="token punctuation">,</span> ErrorCode<span class="token punctuation">.</span><span class="token constant">UN_ERROR</span><span class="token punctuation">,</span> <span class="token string">&quot;用户名或者密码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建UserContext上下文类</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> username <span class="token punctuation">}</span> <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token keyword">const</span> userContext<span class="token operator">:</span> UserContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserContext</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置token缓存</span>
    <span class="token keyword">const</span> accessToken<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtUtil<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>userContext <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> Constant<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> accessToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> expiresInMinutes<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>jwtConfig<span class="token punctuation">.</span>expiresIn<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cacheUtil<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
      key<span class="token punctuation">,</span>
      <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>userContext<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&quot;EX&quot;</span><span class="token punctuation">,</span>
      expiresInMinutes
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 返回登录信息与token</span>
    <span class="token keyword">const</span> loginVO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoginVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    loginVO<span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>
    loginVO<span class="token punctuation">.</span>roles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    loginVO<span class="token punctuation">.</span>accessToken <span class="token operator">=</span> accessToken<span class="token punctuation">;</span>
    <span class="token keyword">const</span> expiresMillMinutes <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expiresInMinutes <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    loginVO<span class="token punctuation">.</span>expires <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>expiresMillMinutes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> loginVO<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiResponse</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> Captcha <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">&quot;/captchaGet&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> description<span class="token operator">:</span> <span class="token string">&quot;获取验证码&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">getImageCaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Captcha<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> imageBase64 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>captchaService<span class="token punctuation">.</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      width<span class="token operator">:</span> <span class="token number">120</span><span class="token punctuation">,</span>
      height<span class="token operator">:</span> <span class="token number">40</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> captchaPrefixId<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>captchaService<span class="token punctuation">.</span>captcha<span class="token punctuation">.</span>idPrefix<span class="token punctuation">;</span>
    <span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>captchaService<span class="token punctuation">.</span>cacheManager<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>captchaPrefixId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;当前验证的文本信息是：%s&quot;</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      id<span class="token punctuation">,</span> <span class="token comment">// 验证码 id</span>
      imageBase64<span class="token punctuation">,</span> <span class="token comment">// 验证码 SVG 图片的 base64 数据，可以直接放入前端的 img 标签内</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="swagger-集成" tabindex="-1"><a class="header-anchor" href="#swagger-集成" aria-hidden="true">#</a> Swagger 集成</h2><p>Swagger 是一个集成在系统内部，能够通过装饰类描述接口文档的工具，可以方便的测试接口。</p><h3 id="安装-swagger-组件" tabindex="-1"><a class="header-anchor" href="#安装-swagger-组件" aria-hidden="true">#</a> 安装 Swagger 组件</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> @midwayjs/swagger@3 <span class="token parameter variable">--save</span>
<span class="token function">npm</span> <span class="token function">install</span> swagger-ui-dist <span class="token parameter variable">--save</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="注册组件" tabindex="-1"><a class="header-anchor" href="#注册组件" aria-hidden="true">#</a> 注册组件</h3><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/configuration.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> swagger <span class="token keyword">from</span> <span class="token string">&quot;@midwayjs/swagger&quot;</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Configuration</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    swagger<span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ContainerLifeCycle</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="验证-swagger" tabindex="-1"><a class="header-anchor" href="#验证-swagger" aria-hidden="true">#</a> 验证 Swagger</h3><p>启动后访问：<code>http://127.0.0.1:7001/swagger-ui/index.html</code></p><figure><img src="https://misaka10032.oss-cn-chengdu.aliyuncs.com/midway/midway-swaggerImage.png" alt="Swagger验证图" tabindex="0" loading="lazy"><figcaption>Swagger验证图</figcaption></figure><h3 id="测试接口" tabindex="-1"><a class="header-anchor" href="#测试接口" aria-hidden="true">#</a> 测试接口</h3><p>验证接口，提示 <code>缺少凭证</code>，需要 Swagger 支持 bearer 验证。</p><figure><img src="https://misaka10032.oss-cn-chengdu.aliyuncs.com/midway/swagger-needBearer.png" alt="Swagger缺少凭证" tabindex="0" loading="lazy"><figcaption>Swagger缺少凭证</figcaption></figure><h3 id="添加-bearer-支持" tabindex="-1"><a class="header-anchor" href="#添加-bearer-支持" aria-hidden="true">#</a> 添加 bearer 支持</h3><p>添加配置</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/config/config.default.ts</span>
swagger<span class="token operator">:</span> <span class="token punctuation">{</span>
  auth<span class="token operator">:</span> <span class="token punctuation">{</span>
    authType<span class="token operator">:</span> <span class="token string">&#39;bearer&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在对应 Controller 中添加注解 <code>@ApiBearerAuth()</code></p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/controller/user.controller.ts</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">ApiBearerAuth</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">&quot;/api/user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="swagger-常用装饰类" tabindex="-1"><a class="header-anchor" href="#swagger-常用装饰类" aria-hidden="true">#</a> Swagger 常用装饰类</h3><ul><li><code>@ApiTags()</code> 通常用于 Controller，将其分类标记；</li><li><code>@ApiResponse()</code> 用于标注 API 的返回值；</li><li><code>@ApiProperty()</code> 用于标注返回 DTO、VO，实体类的属性；</li></ul><p>关于 Swagger 的详细使用文档，见：</p>`,44),C={href:"http://www.midwayjs.org/docs/extensions/swagger",target:"_blank",rel:"noopener noreferrer"},j=p(`<h3 id="使用-swagger-knife4j2" tabindex="-1"><a class="header-anchor" href="#使用-swagger-knife4j2" aria-hidden="true">#</a> 使用 Swagger Knife4j2</h3><p>安装</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> midwayjs-kinfe4j2 <span class="token parameter variable">--save</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>依赖</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;@midwayjs/swagger&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.3.14&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;midwayjs-kinfe4j2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.0.2&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改导入</p><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token operator">??</span><span class="token operator">?</span> <span class="token keyword">from</span> <span class="token string">&#39;@midwayjs/swagger&#39;</span><span class="token punctuation">;</span>
<span class="token comment">// 改为</span>
<span class="token keyword">import</span> <span class="token operator">??</span><span class="token operator">?</span> <span class="token keyword">from</span> <span class="token string">&#39;midwayjs-knife4j2&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="环境变量" tabindex="-1"><a class="header-anchor" href="#环境变量" aria-hidden="true">#</a> 环境变量</h2><p>通常我们不希望将生产环境的相关配置写在项目代码中，而希望在不同的环境中启动时自动读取环境中设置的配置； 在本教程中，我也不希望将自己的数据库、缓存 IP 提交到代码仓库，所以可以使用环境变量+host；</p><h3 id="安装-env-组件" tabindex="-1"><a class="header-anchor" href="#安装-env-组件" aria-hidden="true">#</a> 安装 env 组件</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> dotenv <span class="token parameter variable">--save</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="初始化环境变量" tabindex="-1"><a class="header-anchor" href="#初始化环境变量" aria-hidden="true">#</a> 初始化环境变量</h3><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/configuration.ts</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> dotenv <span class="token keyword">from</span> <span class="token string">&quot;dotenv&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化环境变量 默认获取.env文件</span>
<span class="token comment">// 如果要区分不同环境使用不同文件，在config中传入\`.env.\${p<wbr>rocess.env.NODE_ENV}\`并在根目录创建对应文件即可</span>
dotenv<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Configuration</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ContainerLifeCycle</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="配置变量" tabindex="-1"><a class="header-anchor" href="#配置变量" aria-hidden="true">#</a> 配置变量</h3><p>在根目录添加文件 <code>.env</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>// .env
MYSQL_HOST=devserver
MYSQL_USERNAME=dev
MYSQL_PASSWORD=123456
MYSQL_PORT=3306
REDIS_HOST=devserver
REDIS_PORT=6379
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 host 文件中添加域名映射</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>// windows电脑
// C:\\Windows\\System32\\drivers\\etc\\hosts
// xx.xx.xx.xx 为你自己mysql、redis的ip，如果在一台机器上的话
xx.xx.xx.xx devserver 如果部署目标服务器也在同一台机器，这一步可以省略，devServer直接选用127.0.0.1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用变量" tabindex="-1"><a class="header-anchor" href="#使用变量" aria-hidden="true">#</a> 使用变量</h3><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token comment">// src/config/config.default.ts</span>
typeorm<span class="token operator">:</span> <span class="token punctuation">{</span>
  dataSource<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&#39;mysql&#39;</span><span class="token punctuation">,</span>
      host<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MYSQL_HOST</span><span class="token punctuation">,</span>
      port<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MYSQL_PORT</span><span class="token punctuation">,</span>
      username<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MYSQL_USERNAME</span><span class="token punctuation">,</span>
      password<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MYSQL_PASSWORD</span><span class="token punctuation">,</span>
      database<span class="token operator">:</span> <span class="token string">&#39;midway_boot&#39;</span><span class="token punctuation">,</span>
      synchronize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 如果第一次使用，不存在表，有同步的需求可以写 true</span>
      logging<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      entities<span class="token operator">:</span> <span class="token punctuation">[</span>User<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// redis配置</span>
redis<span class="token operator">:</span> <span class="token punctuation">{</span>
  client<span class="token operator">:</span> <span class="token punctuation">{</span>
    host<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_HOST</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REDIS_PORT</span><span class="token punctuation">,</span>
    db<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在生产环境中使用，你可以将环境变量配置到系统中，如果你是 Docker 启动，可以指定环境变量文件。</p><h2 id="部署" tabindex="-1"><a class="header-anchor" href="#部署" aria-hidden="true">#</a> 部署</h2><h3 id="构建-docker-镜像" tabindex="-1"><a class="header-anchor" href="#构建-docker-镜像" aria-hidden="true">#</a> 构建 Docker 镜像</h3><p>Docker 是基于 Go 语言进行开发实现，一个开源的应用容器引擎。</p><p>为什么要用 Docker？</p><ol><li>可以使用镜像快速构建一套标准的开发环境，快速部署代码；</li><li>高效的资源利用，可以实现更高的性能，同时对资源的额外需求很低；</li><li>兼容性高，让用户可以在不同平台间轻松的迁移应用；</li><li>可以实现自动化且高效的容器管理。</li></ol><p>如何构建 Docker？</p><p>在项目根目录中添加 Dockerfile 构建配置文件</p><div class="language-docker line-numbers-mode" data-ext="docker"><pre class="language-docker"><code><span class="token instruction"><span class="token keyword">FROM</span> node:16.14.2-alpine</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">ENV</span> TZ=<span class="token string">&quot;Asia/Shanghai&quot;</span></span>

<span class="token instruction"><span class="token keyword">COPY</span> . .</span>

<span class="token instruction"><span class="token keyword">RUN</span> npm install --registry=https://registry.npm.taobao.org</span>
<span class="token instruction"><span class="token keyword">RUN</span> npm run build</span>
<span class="token comment"># 移除开发环境的依赖</span>
<span class="token instruction"><span class="token keyword">RUN</span> npm prune --production</span>

<span class="token comment"># 暴露端口（内部）</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 7001</span>

<span class="token comment"># 设定容器启动时第一个运行的命令及其参数</span>
<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;npm&quot;</span>, <span class="token string">&quot;run&quot;</span>, <span class="token string">&quot;start&quot;</span>]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="使用-jenkins-ci-cd" tabindex="-1"><a class="header-anchor" href="#使用-jenkins-ci-cd" aria-hidden="true">#</a> 使用 Jenkins CI/CD</h3><p>编写部署脚本 <code>/opt/services/deploy.sh</code></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token shebang important">#!/bin/sh</span>

<span class="token comment">#./deploy.sh -n hi-mall -v 1.0 -R hiauth -p 8182:8182</span>

<span class="token assign-left variable">url</span><span class="token operator">=</span><span class="token string">&#39;bestaone&#39;</span>

<span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">&quot;1.0&quot;</span>
<span class="token assign-left variable">registry</span><span class="token operator">=</span><span class="token string">&quot;hlll&quot;</span>
<span class="token assign-left variable">portMapping</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">opts</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>
<span class="token assign-left variable">envFile</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>

<span class="token keyword">function</span> <span class="token function-name function">useage</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token builtin class-name">echo</span> <span class="token string">&quot;Usage: -n name -v version -p portMapping [-R registry] [-e envFile] [-o opts]&quot;</span>
     <span class="token builtin class-name">echo</span> <span class="token string">&quot;-n name, app name&quot;</span>
     <span class="token builtin class-name">echo</span> <span class="token string">&quot;-v version, deploy image version&quot;</span>
     <span class="token builtin class-name">echo</span> <span class="token string">&quot;-p portMapping, container port mapping&quot;</span>
     <span class="token builtin class-name">echo</span> <span class="token string">&quot;-R registry, image registry&quot;</span>
     <span class="token builtin class-name">echo</span> <span class="token string">&quot;-e envFile, Env File&quot;</span>
     <span class="token builtin class-name">echo</span> <span class="token string">&quot;-o opts, JVM OPST&quot;</span>
     <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token keyword">while</span> <span class="token builtin class-name">getopts</span> <span class="token string">&quot;h:n:v:R:V:p:N:e:o:P:&quot;</span> option
<span class="token keyword">do</span>
    <span class="token keyword">case</span> <span class="token string">&quot;<span class="token variable">\${option}</span>&quot;</span> <span class="token keyword">in</span>
        n<span class="token punctuation">)</span>
            <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token variable">\${OPTARG}</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token function">v</span><span class="token punctuation">)</span>
            <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token variable">\${OPTARG}</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
                p<span class="token punctuation">)</span>
            <span class="token assign-left variable">portMapping</span><span class="token operator">+=</span><span class="token string">&quot; -p &quot;</span><span class="token variable">\${OPTARG}</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
        R<span class="token punctuation">)</span>
            <span class="token assign-left variable">registry</span><span class="token operator">=</span><span class="token variable">\${OPTARG}</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
                e<span class="token punctuation">)</span>
            <span class="token assign-left variable">envFile</span><span class="token operator">=</span><span class="token variable">\${OPTARG}</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
        o<span class="token punctuation">)</span>
            <span class="token assign-left variable">opts</span><span class="token operator">=</span><span class="token variable">\${OPTARG}</span> <span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token punctuation">\\</span>?<span class="token punctuation">)</span>
            useage <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token keyword">esac</span>
<span class="token keyword">done</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">\${name}</span>&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
        useage <span class="token punctuation">;</span>
<span class="token keyword">fi</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">\${portMapping}</span>&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
        useage <span class="token punctuation">;</span>
<span class="token keyword">fi</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;--------------------------------------------------------------------------&quot;</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;Name              = <span class="token variable">\${name}</span>&quot;</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Version           = <span class="token variable">\${version}</span>&quot;</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Opts              = <span class="token variable">\${opts}</span>&quot;</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;Registry          = <span class="token variable">\${registry}</span>&quot;</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;PortMapping       = <span class="token variable">\${portMapping}</span>&quot;</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;EnvFile           = <span class="token variable">\${envFile}</span>&quot;</span>

<span class="token assign-left variable">runcommand</span><span class="token operator">=</span><span class="token string">&quot;&quot;</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;Deploy <span class="token variable">\${name}</span>:<span class="token variable">\${version}</span>&quot;</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;step 1 : shoutdown and remove container&quot;</span>
<span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span> <span class="token parameter variable">--filter</span> <span class="token string">&quot;name=<span class="token variable">$name</span>&quot;</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $1}&#39;</span><span class="token operator">|</span> <span class="token keyword">while</span> <span class="token builtin class-name">read</span> cid
<span class="token keyword">do</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$cid</span> <span class="token operator">!=</span> <span class="token string">&#39;CONTAINER&#39;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
                <span class="token builtin class-name">echo</span> <span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token variable">$cid</span>
                <span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token variable">$cid</span>
        <span class="token keyword">fi</span>
<span class="token keyword">done</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;step 2 : remove image&quot;</span>
<span class="token builtin class-name">echo</span> <span class="token function">docker</span> rmi <span class="token variable">$url</span>/<span class="token variable">$registry</span>/<span class="token variable">$name</span><span class="token builtin class-name">:</span><span class="token variable">$version</span>
<span class="token function">docker</span> rmi <span class="token variable">$url</span>/<span class="token variable">$registry</span>/<span class="token variable">$name</span><span class="token builtin class-name">:</span><span class="token variable">$version</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;step 3 : build new image&quot;</span>
<span class="token builtin class-name">echo</span> <span class="token function">docker</span> build <span class="token parameter variable">-t</span> <span class="token variable">$url</span>/<span class="token variable">$registry</span>/<span class="token variable">$name</span><span class="token builtin class-name">:</span><span class="token variable">$version</span> /opt/services/<span class="token variable">$name</span>
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> <span class="token variable">$url</span>/<span class="token variable">$registry</span>/<span class="token variable">$name</span><span class="token builtin class-name">:</span><span class="token variable">$version</span> /opt/services/<span class="token variable">$name</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;step 4 : run container&quot;</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">\${name}</span>&quot;</span> <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token assign-left variable">runcommand</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${runcommand}</span> --name <span class="token variable">\${name}</span> &quot;</span>
<span class="token keyword">fi</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">\${portMapping}</span>&quot;</span> <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token assign-left variable">runcommand</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${runcommand}</span> <span class="token variable">\${portMapping}</span> &quot;</span>
<span class="token keyword">fi</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">\${volume}</span>&quot;</span> <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token assign-left variable">runcommand</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${runcommand}</span> -v <span class="token variable">\${volume}</span> &quot;</span>
<span class="token keyword">fi</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">\${envFile}</span>&quot;</span> <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token assign-left variable">runcommand</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${runcommand}</span> --env-file <span class="token variable">\${envFile}</span> &quot;</span>
<span class="token keyword">fi</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">\${opts}</span>&quot;</span> <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token assign-left variable">runcommand</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">\${runcommand}</span> -e &#39;JAVA_OPTS=<span class="token variable">\${opts}</span>&#39; &quot;</span>
<span class="token keyword">fi</span>

<span class="token builtin class-name">echo</span> <span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token variable">$runcommand</span> <span class="token variable">$url</span>/<span class="token variable">$registry</span>/<span class="token variable">$name</span><span class="token builtin class-name">:</span><span class="token variable">$version</span>
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token variable">$runcommand</span> <span class="token variable">$url</span>/<span class="token variable">$registry</span>/<span class="token variable">$name</span><span class="token builtin class-name">:</span><span class="token variable">$version</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;step 5 : check deploy&quot;</span>
<span class="token builtin class-name">echo</span> <span class="token function">docker</span> images
<span class="token function">docker</span> images
<span class="token builtin class-name">echo</span> <span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span>
<span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">\${name}</span>:<span class="token variable">\${version}</span> deploy over!&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建 Jenkins 任务</p><p>添加一个自由风格的任务，添加好源码地址(git)，然后添加执行 shell。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 切换目录</span>
<span class="token builtin class-name">cd</span> /root/.jenkins/workspace/midway-boot
<span class="token comment"># 删除旧文件</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /opt/services/midway-boot/*
<span class="token comment"># 复制新文件</span>
<span class="token function">cp</span> <span class="token parameter variable">-rf</span> /root/.jenkins/workspace/midway-boot/* 	/opt/services/midway-boot/

<span class="token comment"># 发布</span>
/opt/services/deploy.sh <span class="token parameter variable">-n</span> midway-boot <span class="token parameter variable">-R</span> midway <span class="token parameter variable">-p</span> <span class="token number">10100</span>:7001 <span class="token parameter variable">-e</span> /opt/services/.env
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>在这之前需要先创建目录 <code>/opt/services/midway-boot</code>，以及添加环境变量配置文件 <code>/opt/services/.env</code></strong></p>`,36);function S(O,I){const a=o("ExternalLinkIcon");return c(),i("div",null,[u,n("p",null,[s("文档仓库链接："),n("a",r,[s("https://github.com/mi-saka10032/jay-music-manage-system"),t(a)])]),n("p",null,[s("参考文档链接："),n("a",k,[s("https://github.com/bestaone/midway-boot/blob/main/Tutorials.md"),t(a)])]),d,n("p",null,[n("a",v,[s("http://www.midwayjs.org/docs/extensions/orm"),t(a)])]),m,n("p",null,[n("a",b,[s("http://www.midwayjs.org/docs/testing"),t(a)])]),y,n("p",null,[n("a",w,[s("http://www.midwayjs.org/docs/middleware"),t(a)])]),g,n("p",null,[n("a",f,[s("http://www.midwayjs.org/docs/extensions/jwt"),t(a)])]),h,n("p",null,[n("a",q,[s("http://www.midwayjs.org/docs/extensions/redis"),t(a)])]),x,n("p",null,[n("a",C,[s("http://www.midwayjs.org/docs/extensions/swagger"),t(a)])]),j])}const T=e(l,[["render",S],["__file","2-midway-init.html.vue"]]);export{T as default};
