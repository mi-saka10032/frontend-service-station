import{_ as n}from"./_plugin-vue_export-helper.cdc0426e.js";import{o as s,c as a,d as e}from"./app.46f24a07.js";const t={},p=e(`<h2 id="原理简述" tabindex="-1"><a class="header-anchor" href="#原理简述" aria-hidden="true">#</a> 原理简述</h2><p>React 提供了有别于原生 DOM 事件系统(onclick)的完整的可插入式合成事件系统(onClick)，其原理是将全部的派发事件全部代理到根节点，然后遵循事件捕获和事件冒泡的顺序执行合成事件</p><ol><li>首先将 React 所定义的全部 DOM 事件名称转化为合成事件名称，这一步称为事件注册</li><li>根节点 Fiber 初始化完成(createContainer)之后，对根节点 DOM 开启已注册事件的代理监听。这一步会将之前已注册的合成事件名进行原生事件名转化，向根节点 DOM 添加事件监听器</li><li>每个原生事件注册的监听函数以事件派发(dispatchEvent)的形式触发，会自底向上地推入回调函数队列，按照事件捕获 =&gt; 事件冒泡的顺序触发这一系列合成事件</li></ol><p>下面将分阶段介绍事件系统的实现</p><h2 id="事件注册" tabindex="-1"><a class="header-anchor" href="#事件注册" aria-hidden="true">#</a> 事件注册</h2><p>事件注册阶段，将事件名 Set 中全部需注册的原生事件遍历一遍，并结合对应的 React 事件名生成映射关系 Map，最终将注册事件名称添加到 allNativeEvents 的 Set 中</p><h3 id="domplugineventsystem-js" tabindex="-1"><a class="header-anchor" href="#domplugineventsystem-js" aria-hidden="true">#</a> DOMPluginEventSystem.js</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> SimpleEventPlugin <span class="token keyword">from</span> <span class="token string">&quot;./plugins/SimpleEventPlugin&quot;</span><span class="token punctuation">;</span>

SimpleEventPlugin<span class="token punctuation">.</span><span class="token function">registerEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="simpleeventplugin-js" tabindex="-1"><a class="header-anchor" href="#simpleeventplugin-js" aria-hidden="true">#</a> SimpleEventPlugin.js</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> registerSimpleEvents <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../DOMEventProperties&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> registerSimpleEvents <span class="token keyword">as</span> registerEvents <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="domeventproperties-js" tabindex="-1"><a class="header-anchor" href="#domeventproperties-js" aria-hidden="true">#</a> DOMEventProperties.js</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> registerTwoPhaseEvent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-dom/src/events/EventRegistry&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 只注册click事件，其他需要注册的事件往里面添加就可以</span>
<span class="token keyword">const</span> simpleEventPluginEvents <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 存储原生事件名和React事件名的映射关系</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> topLevelEventsTOReactNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">registerSimpleEvent</span><span class="token punctuation">(</span><span class="token parameter">domEventName<span class="token punctuation">,</span> reactName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 把原生事件名和处理函数的名字进行映射或绑定，click =&gt; onClick</span>
  topLevelEventsTOReactNames<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>domEventName<span class="token punctuation">,</span> reactName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">registerTwoPhaseEvent</span><span class="token punctuation">(</span>reactName<span class="token punctuation">,</span> <span class="token punctuation">[</span>domEventName<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">registerSimpleEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> simpleEventPluginEvents<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> eventName <span class="token operator">=</span> simpleEventPluginEvents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// click</span>
    <span class="token keyword">const</span> domEventName <span class="token operator">=</span> eventName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// click</span>
    <span class="token keyword">const</span> capitalizeEvent <span class="token operator">=</span> eventName<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> eventName<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Click</span>
    <span class="token function">registerSimpleEvent</span><span class="token punctuation">(</span>domEventName<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">on</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>capitalizeEvent<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// click onClick</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="eventregistry-js" tabindex="-1"><a class="header-anchor" href="#eventregistry-js" aria-hidden="true">#</a> EventRegistry.js</h3><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> allNativeEvents <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 注册两个阶段的事件名
 * 当页面中触发事件的时候，会走事件处理函数
 * 事件处理函数需要找到DOM元素对应要执行的React事件，onClick、onClickCapture等
 * <span class="token keyword">@param</span> <span class="token parameter">registrationName</span> React事件名
 * <span class="token keyword">@param</span> <span class="token parameter">dependencies</span> 原生事件数组[click]
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">registerTwoPhaseEvent</span><span class="token punctuation">(</span><span class="token parameter">registrationName<span class="token punctuation">,</span> dependencies</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 注册冒泡事件关系</span>
  <span class="token function">registerDirectEvent</span><span class="token punctuation">(</span>registrationName<span class="token punctuation">,</span> dependencies<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 注册捕获事件关系</span>
  <span class="token function">registerDirectEvent</span><span class="token punctuation">(</span>registrationName <span class="token operator">+</span> <span class="token string">&quot;Capture&quot;</span><span class="token punctuation">,</span> dependencies<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">registerDirectEvent</span><span class="token punctuation">(</span><span class="token parameter">registrationName<span class="token punctuation">,</span> dependencies</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dependencies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    allNativeEvents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependencies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// click</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,14),o=[p];function c(i,l){return s(),a("div",null,o)}const k=n(t,[["render",c],["__file","3-event.html.vue"]]);export{k as default};
